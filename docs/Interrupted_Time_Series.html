<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.556">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chrissy h Roberts &amp; Yonggang Li">

<title>Code Book - 13&nbsp; Segmented Regression Analysis of Interrupted Time Series</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./new_lm_predict_left_predict_right.html" rel="next">
<link href="./Cumulative_Incidence.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="site_libs/datatables-binding-0.33/datatables.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<script src="site_libs/plotly-binding-4.10.4/plotly.js"></script>
<script src="site_libs/typedarray-0.1/typedarray.min.js"></script>
<link href="site_libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="site_libs/plotly-main-2.11.1/plotly-latest.min.js"></script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Cox_PH.html">Statistics</a></li><li class="breadcrumb-item"><a href="./Interrupted_Time_Series.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Segmented Regression Analysis of Interrupted Time Series</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Code Book</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">R | RStudio</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R_basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Basics of R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./extract_model_from_geom_smooth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Extract Model from geom_smooth model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./filename_changer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Rename files procedurally</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Global_Political_Map.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Draw Political Maps (sf geom_sf)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./photo_cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Photo Cleaning For Sharing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./remove_accents.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Remove_Accents</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text_to_speech_R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Text to Speech in R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./UK_Postcodes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">UK Postcode Maps</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./update_R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Update R - Bare Bones</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utf8_encoding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Normalise utf8 accented text</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Statistics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Cox_PH.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Survival Analysis with Cox-PH</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Cumulative_Incidence.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Cumulative Incidence</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Interrupted_Time_Series.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Segmented Regression Analysis of Interrupted Time Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./new_lm_predict_left_predict_right.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">New lm Predict Left &amp; Predict Right</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Diagnostics_Power_Calculation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Diagnostic Evaluation Power Calculation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CI95_point_estimate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">95% Confidence Intervals on a point estimate</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hazratio_chart.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Hazard Ratio Chart from Summary Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./power_calc_gen_case_control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Genetic Power Calculator</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Principal_Components_Analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Principal Components Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Laboratory | Field Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Consent_Forms_with_QR.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Consent Forms with Unique IDs and QR Codes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Digital_Luminex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Digital Luminex</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Generic_Research_Data_Folder_Design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Research study folder template</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./FPC_Grader.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">FPC Grader</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">ODK</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ODK_Biometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">ODK Biometrics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ruODK_basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">ruODK Setup and basic functions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ODK_geofencing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">ODK Geofencing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ODK_Pi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">ODK Pi - A deployable version of ODK on a Raspberry Pi</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Balanced_Prioritisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Balanced Prioritisation Tools For One Health</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./XLSForm_Dictionary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">XLSForm Data Dictionary</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CSV_populate_Central.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Upload CSV file to ODK Central</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Python, bash and other code</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Docker_install_ubuntu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Install Docker</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Join_photos_randomly.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Join Photos side-by-side with tracked random arrangement</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Miscellany</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./badger2040w.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Badger 2040w code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./comic2pdf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Comic formats to PDF</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./remarkable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Remarkable 2 / Paper Pro Template Hacks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CUPS_Zebra_Printer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Zebra ZT220 CUPS Printing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SayMyName.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Say My Name</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Computer_Vision.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Computer Vision</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">13.1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#this-document-provides-examples-of-three-main-type-of-its-analysis" id="toc-this-document-provides-examples-of-three-main-type-of-its-analysis" class="nav-link" data-scroll-target="#this-document-provides-examples-of-three-main-type-of-its-analysis"><span class="header-section-number">13.1.1</span> This document provides examples of three main type of ITS analysis</a></li>
  </ul></li>
  <li><a href="#part-one---uncontrolled-its-one-intervention" id="toc-part-one---uncontrolled-its-one-intervention" class="nav-link" data-scroll-target="#part-one---uncontrolled-its-one-intervention"><span class="header-section-number">13.2</span> Part One - Uncontrolled ITS, one intervention</a>
  <ul class="collapse">
  <li><a href="#autocorrelation" id="toc-autocorrelation" class="nav-link" data-scroll-target="#autocorrelation"><span class="header-section-number">13.2.1</span> Autocorrelation</a></li>
  <li><a href="#a-gls-model-with-a-corarma-correction" id="toc-a-gls-model-with-a-corarma-correction" class="nav-link" data-scroll-target="#a-gls-model-with-a-corarma-correction"><span class="header-section-number">13.2.2</span> A gls model with a corARMA correction</a></li>
  <li><a href="#plot-autocorrelation-function-acf-residuals-1" id="toc-plot-autocorrelation-function-acf-residuals-1" class="nav-link" data-scroll-target="#plot-autocorrelation-function-acf-residuals-1"><span class="header-section-number">13.2.3</span> Plot <strong>Autocorrelation Function (</strong>ACF) residuals</a></li>
  <li><a href="#plot-partial-autocorrelation-function-pacf-residuals-1" id="toc-plot-partial-autocorrelation-function-pacf-residuals-1" class="nav-link" data-scroll-target="#plot-partial-autocorrelation-function-pacf-residuals-1"><span class="header-section-number">13.2.4</span> Plot <strong>Partial Autocorrelation Function</strong> PACF residuals</a></li>
  <li><a href="#a-more-exhaustive-search-for-the-best-autocorrelation-values" id="toc-a-more-exhaustive-search-for-the-best-autocorrelation-values" class="nav-link" data-scroll-target="#a-more-exhaustive-search-for-the-best-autocorrelation-values"><span class="header-section-number">13.2.5</span> A More Exhaustive search for the best autocorrelation values</a></li>
  <li><a href="#show-the-aic-vs-bic" id="toc-show-the-aic-vs-bic" class="nav-link" data-scroll-target="#show-the-aic-vs-bic"><span class="header-section-number">13.2.6</span> Show the AIC vs BIC</a></li>
  </ul></li>
  <li><a href="#check-the-residuals" id="toc-check-the-residuals" class="nav-link" data-scroll-target="#check-the-residuals"><span class="header-section-number">13.3</span> Check the residuals</a>
  <ul class="collapse">
  <li><a href="#plot-partial-autocorrelation-function-pacf-residuals-2" id="toc-plot-partial-autocorrelation-function-pacf-residuals-2" class="nav-link" data-scroll-target="#plot-partial-autocorrelation-function-pacf-residuals-2"><span class="header-section-number">13.3.1</span> Plot <strong>Partial Autocorrelation Function</strong> PACF residuals</a></li>
  </ul></li>
  <li><a href="#look-how-maar-corrections-affect-results" id="toc-look-how-maar-corrections-affect-results" class="nav-link" data-scroll-target="#look-how-maar-corrections-affect-results"><span class="header-section-number">13.4</span> Look how MA/AR corrections affect results</a></li>
  <li><a href="#ljung-box-test" id="toc-ljung-box-test" class="nav-link" data-scroll-target="#ljung-box-test"><span class="header-section-number">13.5</span> Ljung-Box Test</a>
  <ul class="collapse">
  <li><a href="#predicted-values-of-model.b" id="toc-predicted-values-of-model.b" class="nav-link" data-scroll-target="#predicted-values-of-model.b"><span class="header-section-number">13.5.1</span> Predicted values of model.b</a></li>
  </ul></li>
  <li><a href="#part-two---uncontrolled-its-two-interventions" id="toc-part-two---uncontrolled-its-two-interventions" class="nav-link" data-scroll-target="#part-two---uncontrolled-its-two-interventions"><span class="header-section-number">13.6</span> Part Two - Uncontrolled ITS, two interventions</a></li>
  <li><a href="#part-three---controlled-its-one-intervention" id="toc-part-three---controlled-its-one-intervention" class="nav-link" data-scroll-target="#part-three---controlled-its-one-intervention"><span class="header-section-number">13.7</span> Part Three - Controlled ITS, one intervention</a></li>
  <li><a href="#final-word" id="toc-final-word" class="nav-link" data-scroll-target="#final-word"><span class="header-section-number">13.8</span> Final word</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Cox_PH.html">Statistics</a></li><li class="breadcrumb-item"><a href="./Interrupted_Time_Series.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Segmented Regression Analysis of Interrupted Time Series</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Segmented Regression Analysis of Interrupted Time Series</span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Chrissy h Roberts &amp; Yonggang Li </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">13.1</span> Introduction</h2>
<p>This is a brief introduction to Interrupted Time Series analyses. It’s intended for use by people who have done some reading and understand about concepts like autocorrelation.</p>
<p>I won’t be explaining all the technical stuff here but will be focussing on getting things done.</p>
<p>The general methods used in this set of examples are very well described in <a href="https://onlinelibrary.wiley.com/doi/full/10.1046/j.1365-2710.2002.00430.x?sid=nlm%3Apubmed">this paper on Segmented regression analysis of interrupted time series studies in medication use research, by Anita K. Wagner and colleagues</a> and I recommend that you start by reading that paper at least twice.</p>
<p>The methods below will show you how to carry out an interrupted time series (ITS) using generalised least squares, accounting for autocorrelation via a corARMA model. We’ll start out with some fairly simple models, then build up to something a bit more complicated, before going on to add a control group.</p>
<p>We’re going to simulate a study where we are interested to know whether the values of a quantity (quantity.x) have changed significantly in response to some kind of intervention. If it helps you to think of a real-world situation, imagine we take weekly measurements of how many bacteria are found on the handles of public toilet doors. Our intervention might be placing signs about handwashing on all the doors. Can we say that putting up the signs correlated with a decrease in the number of bacteria counted each week?</p>
<p>At the core of this analysis is the concept of a counterfactual. We’ll be doing some modelling to estimate what did happen (the factual scenario) and what we expect would have happened (the counterfactual scenario) if we had never hung up the signs about handwashing.</p>
<p>We’ll be measuring whether the parameter <em>quantity.x</em> changes in response to the <em>Intervention</em>, but there are different kinds of change that we might expect.</p>
<p>The change could take two forms including</p>
<ul>
<li>A step change immediately after the intervention
<ul>
<li>for instance because the signs are so effective that everyone suddenly starts washing their hands much better</li>
</ul></li>
<li>A slope/trend change after the intervention
<ul>
<li>because over time, the presence of the signs conditions more and more people to wash their hands. Alternatively, maybe after an initial step change down, it starts to creep back up because people start to ignore the signs</li>
</ul></li>
</ul>
<p>Different real world scenarios may or may not be compatible with the assumptions that these types of change could occur, so use your knowledge to decide which ones to model.</p>
<section id="this-document-provides-examples-of-three-main-type-of-its-analysis" class="level3" data-number="13.1.1">
<h3 data-number="13.1.1" class="anchored" data-anchor-id="this-document-provides-examples-of-three-main-type-of-its-analysis"><span class="header-section-number">13.1.1</span> This document provides examples of three main type of ITS analysis</h3>
<ul>
<li>Part One - Uncontrolled ITS, one intervention</li>
<li>Part Two - Uncontrolled ITS, two interventions</li>
<li>Part Three - Controlled ITS, one intervention</li>
</ul>
<p>In each case we will build a data set that shows each component of the model in a fairly longhand format. It’s totally possible to use fewer variables and to use interactions (shown further down this document) to model all the various components of the ITS, but this is harder to understand to the novice and harder to decode when it comes to reconciling the data frame against the model coefficients that will be used to interpret what effects the interruption had.</p>
<hr>
</section>
</section>
<section id="part-one---uncontrolled-its-one-intervention" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="part-one---uncontrolled-its-one-intervention"><span class="header-section-number">13.2</span> Part One - Uncontrolled ITS, one intervention</h2>
<p>We’ll create a dummy dataframe, where</p>
<ul>
<li><strong>Time</strong> = A number, the time in study weeks (1 - 100 weeks)</li>
<li><strong>Intervention</strong> = A binary indication of whether the Intervention has taken place at Time x</li>
<li><strong>Post.intervention.time</strong> = A number, the time elapsed since the Intervention</li>
<li><strong>quantity.x</strong> = The thing we want to measure</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dummy dataframe</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Here the interruption takes place at week 51</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Time =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Intervention =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">50</span>)),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Post.intervention.time =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>),</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">quantity.x =</span> <span class="fu">c</span>(<span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">200</span><span class="sc">:</span><span class="dv">300</span>, <span class="at">size =</span> <span class="dv">50</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>), <span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">sample</span>(<span class="sc">-</span><span class="dv">20</span><span class="sc">:</span><span class="dv">20</span>, <span class="dv">50</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">170</span>, <span class="at">size =</span> <span class="dv">50</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>), <span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">sample</span>(<span class="sc">-</span><span class="dv">40</span><span class="sc">:</span><span class="dv">40</span>, <span class="dv">50</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit an ARIMA model to generate moderate autocorrelation</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Set seed for reproducibility</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ARIMA(2, 0, 0) model</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>arima_model <span class="ot">&lt;-</span> <span class="fu">Arima</span>(df<span class="sc">$</span>quantity.x, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract residuals and amplify them to introduce moderate effect</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>amplified_residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(arima_model) <span class="sc">*</span> <span class="fl">1.2</span>  <span class="co"># Amplify residuals by multiplying by 1.2</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the amplified residuals back to the original values, leaving the first value intact</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quantity.x =</span> quantity.x <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">0</span>, amplified_residuals[<span class="sc">-</span><span class="dv">1</span>]))</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the dataframe with moderate autocorrelation</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(df, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">100</span>, <span class="at">scrollY =</span> <span class="st">"200px"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-9eceb20dc2a931752ae4" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9eceb20dc2a931752ae4">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50],[279,359.9346083406671,326.8431286959636,285.0616331548375,267.0728626475648,286.3040210768069,322.3445907876648,254.7071059747261,247.5154877151467,323.2744441140554,215.2259673549932,288.1977331091537,279.2831439588341,245.9483073666503,240.9930679477186,273.2786353852572,212.8938987593451,253.9290105121934,308.9517872010148,231.8824321210053,267.8575199186974,198.5004626896458,211.4209043334289,242.0145783507237,271.4823523652342,234.1449861251017,269.1494141409244,263.9524990388437,194.2455789891328,235.0938186025825,282.149414541916,251.7658640450575,204.8844874777292,178.9144593769259,210.1313038165128,256.6656657164802,244.7222102382634,221.7287737675726,172.460999753062,209.2567287260891,242.431897482527,181.9006204804788,173.029761568049,264.36198795453,221.3282998773393,174.1057603341303,175.7228419193296,237.4485043755099,206.385950772405,221.0972984369471,52.39907823201493,79.19844322627333,264.5646761952947,201.843128178229,86.62011354181212,170.3928290813969,120.6843291691617,128.0594169668538,228.053328129761,88.42058903601159,177.2840110648036,57.03767062121092,161.1069447424748,73.70141115535255,121.6466840426977,169.9039412042928,45.26693068257889,155.7847621206591,152.6727831760423,121.4054830517651,93.9712401255954,138.9287724478549,133.725056269861,69.59797013802313,105.2065894250477,11.79512318769941,82.70662824208286,123.3509950896804,130.1932252208169,0.6218532001271271,106.5455367306792,8.132727375427464,-7.236195154076235,0.6221683808014404,43.21370648361822,154.4362456258356,0.6454995176102685,-22.17126849088095,48.29365897429742,68.81679138153746,37.90520576939987,78.84375813858605,34.40065877977939,33.3441138570047,4.724185321481663,-27.32555812438834,95.95107272375077,44.31975770665046,-50.96351762954347,69.03663976029787]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Time<\/th>\n      <th>Intervention<\/th>\n      <th>Post.intervention.time<\/th>\n      <th>quantity.x<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":100,"scrollY":"200px","columnDefs":[{"className":"dt-right","targets":[1,2,3,4]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"Time","targets":1},{"name":"Intervention","targets":2},{"name":"Post.intervention.time","targets":3},{"name":"quantity.x","targets":4}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>In the simplest form, the ITS model looks like this</p>
<p><strong>gls(quantity.x ~ Time + Intervention + Post.intervention.time, data = df,method=“ML”)</strong></p>
<p>Using the <strong>gls</strong> command from the <em>nlme</em> package, we can create a model that describes the change in quantity.x across time</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>model.a <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> Time <span class="sc">+</span> Intervention <span class="sc">+</span> Post.intervention.time, <span class="at">data =</span> df,<span class="at">method=</span><span class="st">"ML"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Show a summary of the model</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model.a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by maximum likelihood
  Model: quantity.x ~ Time + Intervention + Post.intervention.time 
  Data: df 
       AIC      BIC    logLik
  1049.891 1062.917 -519.9454

Coefficients:
                           Value Std.Error   t-value p-value
(Intercept)            295.79584 12.847369 23.023846  0.0000
Time                    -2.01474  0.438474 -4.594891  0.0000
Intervention           -34.38002 17.902424 -1.920411  0.0578
Post.intervention.time  -0.93919  0.620096 -1.514583  0.1332

 Correlation: 
                       (Intr) Time   Intrvn
Time                   -0.870              
Intervention            0.348 -0.600       
Post.intervention.time  0.615 -0.707 -0.017

Standardized residuals:
       Min         Q1        Med         Q3        Max 
-2.4025774 -0.6727850  0.0287960  0.7829453  2.5718791 

Residual standard error: 43.83865 
Degrees of freedom: 100 total; 96 residual</code></pre>
</div>
</div>
<p>These coefficients have real world meaning and are not there to be ignored.</p>
<p>This tells us that the modelled line passes the y axis at 295.6 units and that prior to the intervention, the average value of quantity.x was falling by 1.98 units per week. At the intervention, there was a step change of -24.8 units and subsequent to the intervention there was a trend in which the value of quantity.x fell by <em>an additional</em> 1.12 units per week. The last distinction is important because that means that after the intervention, the weekly decrease in quantity.x was 1.98 + 1.12 = 3.10</p>
<p>These statistics tell us whether the changes that happened at different timepoints were significant with respect to what the line was doing before the interruption. These values can be used to calculate the overall difference in quantity.x between times [i] and [ii] using this formula</p>
<p><strong>quantity.x[i] = 308.27918 + (Time[i]*-1.97565) + (Intervention[i]*-27.33565) + (Post.intervention.time[i]*-1.17575)</strong></p>
<p><strong>quantity.x[ii] = 308.27918 + (Time[ii]*-1.97565) + (Intervention[ii]*-27.33565) + (Post.intervention.time[ii]*-1.17575)</strong></p>
<p><strong>absolute difference = difference(quantity.x[i] , quantity.x[ii])</strong></p>
<p>But what would be nice would be to calculate the counterfactual scenario where the intervention didn’t happen and to estimate the difference between the factual values of quantity.x at time [i] and the counterfactuals at the same time [i]. This is coming up later.</p>
<p>It’s nice to add values from models to the df, so we will next copy the modelled values of quantity.x in to the df using the <strong>predictSE.gls</strong> command from the <strong>AICcmodavg</strong> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df<span class="ot">&lt;-</span>df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.a.predictions =</span> <span class="fu">predictSE.gls</span> (model.a, df, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.a.se =</span> <span class="fu">predictSE.gls</span> (model.a, df, <span class="at">se.fit=</span>T)<span class="sc">$</span>se</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we captured both the predicted value of quantity.x and also the standard error on the estimate. We’ll need that to show the error margins and to draw confidence intervals on our charts.</p>
<p>Let’s draw a picture on which we will show the raw data points, then add the modelled data as a line describing the factual observations and a ribbon showing the 95% confidence interval on the model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df,<span class="fu">aes</span>(Time,quantity.x))<span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.a.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.a.se), <span class="at">ymax =</span> model.a.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.a.se)), <span class="at">fill =</span> <span class="st">"lightgreen"</span>)<span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.a.predictions),<span class="at">color=</span><span class="st">"black"</span>,<span class="at">lty=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Interrupted_Time_Series_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Before we get too much further though, we need to look at autocorrelation in the data. gls allows us to add corARMA structures by specifying values for p (the autoregressive order) and q (the moving average order).</p>
<section id="autocorrelation" class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="autocorrelation"><span class="header-section-number">13.2.1</span> Autocorrelation</h3>
<p>Adding residual diagnostics can be nice start point from which to explore the data and see if we can see evidence for autocorrelation</p>
<p>First we’ll define a function to extract the residuals from an ITS dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate ACF or PACF values</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>get_acf_pacf <span class="ot">&lt;-</span> <span class="cf">function</span>(residuals, max_lag, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"acf"</span>, <span class="st">"pacf"</span>), model_name) {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  type <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(type)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"acf"</span>) {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    values <span class="ot">&lt;-</span> <span class="fu">acf</span>(residuals, <span class="at">lag.max =</span> max_lag, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    values <span class="ot">&lt;-</span> <span class="fu">pacf</span>(residuals, <span class="at">lag.max =</span> max_lag, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> values<span class="sc">$</span>lag,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">acf =</span> values<span class="sc">$</span>acf,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> model_name,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> type</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll also need to think about a threshold value at which a residual is significant. Let’s set this to 95% of the distribution of values for <code>quantity.x</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(df<span class="sc">$</span>quantity.x) <span class="co"># Number of observations</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="fl">1.96</span> <span class="sc">/</span> <span class="fu">sqrt</span>(n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we’ll extract the residuals from model.a</p>
<p>This is annual data, so the longest lag <code>max_lag</code> we could imagine would be a full year 52 week cycle</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract normalized residuals from the models</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>residuals_a <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model.a, <span class="at">type =</span> <span class="st">'normalized'</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the maximum lag for the autocorrelation and partial autocorrelation functions</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>max_lag <span class="ot">&lt;-</span> <span class="dv">52</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get ACF and PACF data for model.a</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>acf_a <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_a, max_lag, <span class="st">"acf"</span>, <span class="st">"Model A"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>pacf_a <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_a, max_lag, <span class="st">"pacf"</span>, <span class="st">"Model A"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="plot-autocorrelation-function-acf-residuals" class="level4" data-number="13.2.1.1">
<h4 data-number="13.2.1.1" class="anchored" data-anchor-id="plot-autocorrelation-function-acf-residuals"><span class="header-section-number">13.2.1.1</span> Plot <strong>Autocorrelation Function (</strong>ACF) residuals</h4>
<p>The ACF (Autocorrelation Function)&nbsp;is primarily used to determine the appropriate value for the&nbsp;Moving Average (MA)order&nbsp;<code>q</code>&nbsp;in an&nbsp;ARIMA&nbsp;model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(acf_a, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>threshold, threshold), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"ACF for Model A"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lag"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"ACF"</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-f30d7598595affc4f25a" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-f30d7598595affc4f25a">{"x":{"data":[{"orientation":"v","width":[0.90000000000000002,0.89999999999999991,0.90000000000000013,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.89999999999999947,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.90000000000000213,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568],"base":[0,-0.166098539112007,-0.25499418131922758,0,0,0,0,-0.018292444669066838,-0.048752628836089634,0,-0.18085330263710012,-0.0032879061068683203,0,0,-0.15123996856831137,-0.1204584406774403,0,-0.021703640799193711,0,-0.029581588698106627,-0.0042628748767489363,-0.077162348529058344,0,-0.01233968900370413,-0.095741038377443077,0,-0.1028190692843598,-0.11693860749432576,0,0,-0.15144231998787228,0,0,0,0,-0.087071320276416078,-0.050337759095055452,0,0,-0.12460968933334203,-0.057171294029574389,0,0,-0.04683187997436733,0,-0.046316245827670972,-0.06585212641390556,0,-0.046358899477104677,-0.024859835922918936,0,0,-0.079102050103524654],"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52],"y":[1,0.166098539112007,0.25499418131922758,0.0048271518675864471,0.00010095757250215613,0.10068510621981155,0.032265292711705314,0.018292444669066838,0.048752628836089634,0.078042138428785116,0.18085330263710012,0.0032879061068683203,0.12347541508796715,0.069529239611773569,0.15123996856831137,0.1204584406774403,0.071047887848051119,0.021703640799193711,0.03964580983037843,0.029581588698106627,0.0042628748767489363,0.077162348529058344,0.055351654011399853,0.01233968900370413,0.095741038377443077,0.21323154338637498,0.1028190692843598,0.11693860749432576,0.10752124637666093,0.094320754216297556,0.15144231998787228,0.0063964830504899184,0.04963750530649616,0.030427286508448614,0.052573663748431164,0.087071320276416078,0.050337759095055452,0.065753641129055088,0.076302595933820647,0.12460968933334203,0.057171294029574389,0.11499407502418602,0.037303759179689082,0.04683187997436733,0.054221647192494733,0.046316245827670972,0.06585212641390556,0.094778067692564374,0.046358899477104677,0.024859835922918936,0.010894905902878142,0.0036556172675423783,0.079102050103524654],"text":["lag:  0<br />acf: 1.0000000000","lag:  1<br />acf: 0.1660985391","lag:  2<br />acf: 0.2549941813","lag:  3<br />acf: 0.0048271519","lag:  4<br />acf: 0.0001009576","lag:  5<br />acf: 0.1006851062","lag:  6<br />acf: 0.0322652927","lag:  7<br />acf: 0.0182924447","lag:  8<br />acf: 0.0487526288","lag:  9<br />acf: 0.0780421384","lag: 10<br />acf: 0.1808533026","lag: 11<br />acf: 0.0032879061","lag: 12<br />acf: 0.1234754151","lag: 13<br />acf: 0.0695292396","lag: 14<br />acf: 0.1512399686","lag: 15<br />acf: 0.1204584407","lag: 16<br />acf: 0.0710478878","lag: 17<br />acf: 0.0217036408","lag: 18<br />acf: 0.0396458098","lag: 19<br />acf: 0.0295815887","lag: 20<br />acf: 0.0042628749","lag: 21<br />acf: 0.0771623485","lag: 22<br />acf: 0.0553516540","lag: 23<br />acf: 0.0123396890","lag: 24<br />acf: 0.0957410384","lag: 25<br />acf: 0.2132315434","lag: 26<br />acf: 0.1028190693","lag: 27<br />acf: 0.1169386075","lag: 28<br />acf: 0.1075212464","lag: 29<br />acf: 0.0943207542","lag: 30<br />acf: 0.1514423200","lag: 31<br />acf: 0.0063964831","lag: 32<br />acf: 0.0496375053","lag: 33<br />acf: 0.0304272865","lag: 34<br />acf: 0.0525736637","lag: 35<br />acf: 0.0870713203","lag: 36<br />acf: 0.0503377591","lag: 37<br />acf: 0.0657536411","lag: 38<br />acf: 0.0763025959","lag: 39<br />acf: 0.1246096893","lag: 40<br />acf: 0.0571712940","lag: 41<br />acf: 0.1149940750","lag: 42<br />acf: 0.0373037592","lag: 43<br />acf: 0.0468318800","lag: 44<br />acf: 0.0542216472","lag: 45<br />acf: 0.0463162458","lag: 46<br />acf: 0.0658521264","lag: 47<br />acf: 0.0947780677","lag: 48<br />acf: 0.0463588995","lag: 49<br />acf: 0.0248598359","lag: 50<br />acf: 0.0108949059","lag: 51<br />acf: 0.0036556173","lag: 52<br />acf: 0.0791020501"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(70,130,180,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-3.0950000000000006,55.095000000000006,null,-3.0950000000000006,55.095000000000006],"y":[-0.19600000000000001,-0.19600000000000001,null,0.19600000000000001,0.19600000000000001],"text":["yintercept: -0.196","yintercept: -0.196",null,"yintercept:  0.196","yintercept:  0.196"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(255,0,0,1)","dash":"dash"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":43.762557077625573,"r":7.3059360730593621,"b":40.182648401826498,"l":43.105022831050235},"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"title":{"text":"ACF for Model A","font":{"color":"rgba(0,0,0,1)","family":"","size":17.534246575342465},"x":0,"xref":"paper"},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-3.0950000000000006,55.095000000000006],"tickmode":"array","ticktext":["0","10","20","30","40","50"],"tickvals":[0,10,20,30,40,50],"categoryorder":"array","categoryarray":["0","10","20","30","40","50"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":{"text":"Lag","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.31774389038518897,1.0627497090659614],"tickmode":"array","ticktext":["0.0","0.4","0.8"],"tickvals":[0,0.39999999999999997,0.80000000000000004],"categoryorder":"array","categoryarray":["0.0","0.4","0.8"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"x","title":{"text":"ACF","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":false,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"80016c7edf28":{"x":{},"y":{},"type":"bar"},"80017d6cf2bd":{"yintercept":{}}},"cur_data":"80016c7edf28","visdat":{"80016c7edf28":["function (y) ","x"],"80017d6cf2bd":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The big spike at&nbsp;<strong>lag 0</strong>&nbsp;in the ACF of the residuals is entirely expected. This just shows how any data point is correlated to itself and can be ignored. If you have other significant spikes, then this might be addressed by including a&nbsp;moving average (MA) term. In a corARMA model, this means defining the value <code>q.</code> If you have spikes in higher lags, then maybe you need to increase the value of q to match. Those spikes imply that there is still <code>autocorrelation</code>&nbsp;in the data that has not been captured by the model. If you include q=2, then the moving average would include both of the lagged residuals up to 2 (i.e.&nbsp;lag =1, lag = 2)</p>
<p>You should look for where the ACF&nbsp;cuts off&nbsp;(i.e.&nbsp;where it drops to within the confidence bounds)</p>
<p>If the&nbsp;ACF&nbsp;shows significant correlations for the first few lags, but then&nbsp;cuts off&nbsp;after a specific lag (say lag&nbsp;2, as seen here), it suggests that an&nbsp;MA(2) [i.e.&nbsp;q=2]&nbsp;model might be appropriate.</p>
<p>This is because the&nbsp;MA model&nbsp;accounts for how current values are related to past&nbsp;forecast errors.</p>
</section>
<section id="plot-partial-autocorrelation-function-pacf-residuals" class="level4" data-number="13.2.1.2">
<h4 data-number="13.2.1.2" class="anchored" data-anchor-id="plot-partial-autocorrelation-function-pacf-residuals"><span class="header-section-number">13.2.1.2</span> Plot <strong>Partial Autocorrelation Function</strong> PACF residuals</h4>
<p>PACF (Partial Autocorrelation Function)&nbsp;is used to determine the appropriate value for the&nbsp;Autoregressive (AR)&nbsp;order&nbsp;<code>p</code>&nbsp;in an&nbsp;ARIMA&nbsp;model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pacf_a, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>threshold, threshold), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> model) <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PACF for Model A"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lag"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PACF"</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-b85bf888dc62471906a9" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-b85bf888dc62471906a9">{"x":{"data":[{"orientation":"v","width":[0.89999999999999991,0.90000000000000013,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.89999999999999947,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.90000000000000213,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568],"base":[-0.166098539112007,-0.29060019478463878,-0.11019231354588904,-0.11044813772576276,0,0,0,-0.0069529205189665473,0,-0.19522052581551896,-0.067465579512533527,-0.0065830534285992292,0,-0.11140188324557355,-0.1051312199239349,-0.034904708162389345,-0.097785902554745535,-0.044296973822100343,-0.028607816180746364,0,-0.11044205191440767,0,-0.020321448997980354,-0.14401290019103147,0,-0.063931239544753077,-0.08427283981971391,0,0,-0.15402987166339746,-0.073842925800364459,-0.0090657953029595617,0,-0.026131348459856828,0,-0.061984893812730375,-0.029854573589143639,-0.0087795752590108696,-0.044030127942692308,-0.14341509187984749,-0.019197777417986082,0,0,0,-0.060710548659088988,-0.080335753977233915,-0.0078716433762441671,-0.037831005970534175,-0.018171572091294767,-0.13740837777508058,-0.022510732413462721,-0.052306546822607727],"x":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52],"y":[0.166098539112007,0.29060019478463878,0.11019231354588904,0.11044813772576276,0.056417204657661049,0.049885759882867316,0.057977829245226806,0.0069529205189665473,0.096299203066017719,0.19522052581551896,0.067465579512533527,0.0065830534285992292,0.097311377594084564,0.11140188324557355,0.1051312199239349,0.034904708162389345,0.097785902554745535,0.044296973822100343,0.028607816180746364,0.0019268228747075175,0.11044205191440767,0.033131461602787821,0.020321448997980354,0.14401290019103147,0.10994907917292915,0.063931239544753077,0.08427283981971391,0.033368280611581619,0.081851630171081532,0.15402987166339746,0.073842925800364459,0.0090657953029595617,0.053090034830077848,0.026131348459856828,0.0056144182050972069,0.061984893812730375,0.029854573589143639,0.0087795752590108696,0.044030127942692308,0.14341509187984749,0.019197777417986082,0.065751193146626294,0.022624669072824993,0.087989953152190478,0.060710548659088988,0.080335753977233915,0.0078716433762441671,0.037831005970534175,0.018171572091294767,0.13740837777508058,0.022510732413462721,0.052306546822607727],"text":["lag:  1<br />acf: 0.166098539","lag:  2<br />acf: 0.290600195","lag:  3<br />acf: 0.110192314","lag:  4<br />acf: 0.110448138","lag:  5<br />acf: 0.056417205","lag:  6<br />acf: 0.049885760","lag:  7<br />acf: 0.057977829","lag:  8<br />acf: 0.006952921","lag:  9<br />acf: 0.096299203","lag: 10<br />acf: 0.195220526","lag: 11<br />acf: 0.067465580","lag: 12<br />acf: 0.006583053","lag: 13<br />acf: 0.097311378","lag: 14<br />acf: 0.111401883","lag: 15<br />acf: 0.105131220","lag: 16<br />acf: 0.034904708","lag: 17<br />acf: 0.097785903","lag: 18<br />acf: 0.044296974","lag: 19<br />acf: 0.028607816","lag: 20<br />acf: 0.001926823","lag: 21<br />acf: 0.110442052","lag: 22<br />acf: 0.033131462","lag: 23<br />acf: 0.020321449","lag: 24<br />acf: 0.144012900","lag: 25<br />acf: 0.109949079","lag: 26<br />acf: 0.063931240","lag: 27<br />acf: 0.084272840","lag: 28<br />acf: 0.033368281","lag: 29<br />acf: 0.081851630","lag: 30<br />acf: 0.154029872","lag: 31<br />acf: 0.073842926","lag: 32<br />acf: 0.009065795","lag: 33<br />acf: 0.053090035","lag: 34<br />acf: 0.026131348","lag: 35<br />acf: 0.005614418","lag: 36<br />acf: 0.061984894","lag: 37<br />acf: 0.029854574","lag: 38<br />acf: 0.008779575","lag: 39<br />acf: 0.044030128","lag: 40<br />acf: 0.143415092","lag: 41<br />acf: 0.019197777","lag: 42<br />acf: 0.065751193","lag: 43<br />acf: 0.022624669","lag: 44<br />acf: 0.087989953","lag: 45<br />acf: 0.060710549","lag: 46<br />acf: 0.080335754","lag: 47<br />acf: 0.007871643","lag: 48<br />acf: 0.037831006","lag: 49<br />acf: 0.018171572","lag: 50<br />acf: 0.137408378","lag: 51<br />acf: 0.022510732","lag: 52<br />acf: 0.052306547"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(70,130,180,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-2.0450000000000008,55.045000000000002,null,-2.0450000000000008,55.045000000000002],"y":[-0.19600000000000001,-0.19600000000000001,null,0.19600000000000001,0.19600000000000001],"text":["yintercept: -0.196","yintercept: -0.196",null,"yintercept:  0.196","yintercept:  0.196"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(255,0,0,1)","dash":"dash"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":55.452054794520549,"r":7.3059360730593621,"b":40.182648401826498,"l":48.949771689497723},"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"title":{"text":"PACF for Model A","font":{"color":"rgba(0,0,0,1)","family":"","size":17.534246575342465},"x":0,"xref":"paper"},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-2.0450000000000008,55.045000000000002],"tickmode":"array","ticktext":["0","10","20","30","40","50"],"tickvals":[0,10,20,30,40,50],"categoryorder":"array","categoryarray":["0","10","20","30","40","50"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":"","hoverformat":".2f"},"annotations":[{"text":"Lag","x":0.5,"y":0,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"top","annotationType":"axis","yshift":-21.917808219178081},{"text":"PACF","x":0,"y":0.5,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-90,"xanchor":"right","yanchor":"center","annotationType":"axis","xshift":-33.607305936073068},{"text":"Model A","x":0.5,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.68949771689498},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"}],"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.31493020452387072,0.22033000973923195],"tickmode":"array","ticktext":["-0.3","-0.2","-0.1","0.0","0.1","0.2"],"tickvals":[-0.30000000000000004,-0.20000000000000004,-0.10000000000000003,0,0.099999999999999978,0.1999999999999999],"categoryorder":"array","categoryarray":["-0.3","-0.2","-0.1","0.0","0.1","0.2"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"x","title":"","hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":23.37899543378996,"yanchor":1,"ysizemode":"pixel"}],"showlegend":false,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"80013bb7223e":{"x":{},"y":{},"type":"bar"},"800174293312":{"yintercept":{}}},"cur_data":"80013bb7223e","visdat":{"80013bb7223e":["function (y) ","x"],"800174293312":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The PACF plot helps identify the lag order by indicating the&nbsp;direct effect&nbsp;of each lag while controlling for intermediate lags.</p>
<p>You should look for where the&nbsp;PACF&nbsp;plot&nbsp;cuts off. For instance, if the&nbsp;PACF&nbsp;has a significant spike at&nbsp;lag 2&nbsp;but becomes insignificant after that, it suggests that an&nbsp;AR(2) [i.e.&nbsp;p=2]&nbsp;model might be appropriate.</p>
<p>This is because an&nbsp;AR model&nbsp;captures the relationship between a current value and its past values.</p>
<p>In this data set there’s a significant spike at ACF lag=2 and another in PACF at 2. This might suggest that we should use an MA(2) AR(2) function. This would relate to p=2, q=2 in the R code.</p>
</section>
</section>
<section id="a-gls-model-with-a-corarma-correction" class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="a-gls-model-with-a-corarma-correction"><span class="header-section-number">13.2.2</span> A gls model with a corARMA correction</h3>
<p>The corrected model looks like this</p>
<p><strong>gls(quantity.x ~ Time + Intervention + Post.intervention.time, data = df,correlation= corARMA(p=1, q=1, form = ~ Time),method=“ML”)</strong></p>
<p>but the critical issue is how to choose the correct values of p and q. There’s lots of information about this online, so read carefully because it is important. Whether you exactly understand what this is all about or not, you’ll still need to take steps to minimise the problem empirically.</p>
<p>So far we’ve looked at the ACF and PACF and have an idea that q=2, p=3 would be a good model for this data.</p>
<p>We’ll start by defining the basic model and then creating a basic R function that can apply different values of p and q to that model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>mod<span class="fl">.1</span> <span class="ot">=</span> quantity.x <span class="sc">~</span> Time <span class="sc">+</span> Intervention <span class="sc">+</span> Post.intervention.time</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>fx <span class="ot">=</span> <span class="cf">function</span>(pval,qval){<span class="fu">summary</span>(<span class="fu">gls</span>(mod<span class="fl">.1</span>, <span class="at">data =</span> df, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span>pval,<span class="at">q=</span>qval, <span class="at">form =</span> <span class="sc">~</span> Time),<span class="at">method=</span><span class="st">"ML"</span>))<span class="sc">$</span>AIC}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, let’s test out the provisional values of p and q.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>model.b <span class="ot">=</span> <span class="fu">gls</span>(mod<span class="fl">.1</span>, <span class="at">data =</span> df, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">2</span>,<span class="at">q=</span><span class="dv">2</span>, <span class="at">form =</span> <span class="sc">~</span> Time),<span class="at">method=</span><span class="st">"ML"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and extract the residuals</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract normalized residuals from the models</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>residuals_b <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model.b, <span class="at">type =</span> <span class="st">'normalized'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get ACF and PACF data for model.a</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>acf_b <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_b, max_lag, <span class="st">"acf"</span>, <span class="st">"Model B"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>pacf_b <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_b, max_lag, <span class="st">"pacf"</span>, <span class="st">"Model B"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-autocorrelation-function-acf-residuals-1" class="level3" data-number="13.2.3">
<h3 data-number="13.2.3" class="anchored" data-anchor-id="plot-autocorrelation-function-acf-residuals-1"><span class="header-section-number">13.2.3</span> Plot <strong>Autocorrelation Function (</strong>ACF) residuals</h3>
<p>The ACF (Autocorrelation Function)&nbsp;is primarily used to determine the appropriate value for the&nbsp;Moving Average (MA)order&nbsp;<code>q</code>&nbsp;in an&nbsp;ARIMA&nbsp;model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(acf_b, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>threshold, threshold), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"ACF for Model B"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lag"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"ACF"</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-88fdd2a34d502a66744b" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-88fdd2a34d502a66744b">{"x":{"data":[{"orientation":"v","width":[0.90000000000000002,0.89999999999999991,0.90000000000000013,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.89999999999999947,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.90000000000000213,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568],"base":[0,-0.0094025597297207261,-0.053112894795532967,0,0,0,0,-0.039699082373227494,-0.043778737942016692,-0.011371790534881609,-0.18897759787862564,-0.094039915342655975,0,-0.03805155681585936,-0.1906980465399461,-0.21833502636210694,-0.02067157685714522,-0.096024819261071093,0,-0.060078220569019514,-0.02318015357160914,-0.079163305799485412,0,-0.011565522670534305,-0.058445491591461708,0,-0.052409125104305065,-0.052437230024362999,0,0,-0.077319291807937396,0,0,0,0,-0.051501437301798736,-0.021162881402178733,0,0,-0.076806818611446379,-0.035110075777163324,0,0,-0.018902699013608894,0,-0.044674897524980758,-0.06755781883470123,0,-0.076701570328448779,-0.051474538048895145,-0.024721016709135703,-0.028668264863751923,-0.10068239105268723],"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52],"y":[1,0.0094025597297207261,0.053112894795532967,0.04481574563499665,0.090218634883711984,0.1016769264602575,0.082085908648158692,0.039699082373227494,0.043778737942016692,0.011371790534881609,0.18897759787862564,0.094039915342655975,0.036930722887219082,0.03805155681585936,0.1906980465399461,0.21833502636210694,0.02067157685714522,0.096024819261071093,0.0033430545579345786,0.060078220569019514,0.02318015357160914,0.079163305799485412,0.039799108564348352,0.011565522670534305,0.058445491591461708,0.19910335546324209,0.052409125104305065,0.052437230024362999,0.11802449077126358,0.12248153063778043,0.077319291807937396,0.052738379802242774,0.067905933586979855,0.051733908218882449,0.065485606998321885,0.051501437301798736,0.021162881402178733,0.077813412176726979,0.067860799237833266,0.076806818611446379,0.035110075777163324,0.11232834385202931,0.035621612797617316,0.018902699013608894,0.038563907640660734,0.044674897524980758,0.06755781883470123,0.058133733559216326,0.076701570328448779,0.051474538048895145,0.024721016709135703,0.028668264863751923,0.10068239105268723],"text":["lag:  0<br />acf: 1.000000000","lag:  1<br />acf: 0.009402560","lag:  2<br />acf: 0.053112895","lag:  3<br />acf: 0.044815746","lag:  4<br />acf: 0.090218635","lag:  5<br />acf: 0.101676926","lag:  6<br />acf: 0.082085909","lag:  7<br />acf: 0.039699082","lag:  8<br />acf: 0.043778738","lag:  9<br />acf: 0.011371791","lag: 10<br />acf: 0.188977598","lag: 11<br />acf: 0.094039915","lag: 12<br />acf: 0.036930723","lag: 13<br />acf: 0.038051557","lag: 14<br />acf: 0.190698047","lag: 15<br />acf: 0.218335026","lag: 16<br />acf: 0.020671577","lag: 17<br />acf: 0.096024819","lag: 18<br />acf: 0.003343055","lag: 19<br />acf: 0.060078221","lag: 20<br />acf: 0.023180154","lag: 21<br />acf: 0.079163306","lag: 22<br />acf: 0.039799109","lag: 23<br />acf: 0.011565523","lag: 24<br />acf: 0.058445492","lag: 25<br />acf: 0.199103355","lag: 26<br />acf: 0.052409125","lag: 27<br />acf: 0.052437230","lag: 28<br />acf: 0.118024491","lag: 29<br />acf: 0.122481531","lag: 30<br />acf: 0.077319292","lag: 31<br />acf: 0.052738380","lag: 32<br />acf: 0.067905934","lag: 33<br />acf: 0.051733908","lag: 34<br />acf: 0.065485607","lag: 35<br />acf: 0.051501437","lag: 36<br />acf: 0.021162881","lag: 37<br />acf: 0.077813412","lag: 38<br />acf: 0.067860799","lag: 39<br />acf: 0.076806819","lag: 40<br />acf: 0.035110076","lag: 41<br />acf: 0.112328344","lag: 42<br />acf: 0.035621613","lag: 43<br />acf: 0.018902699","lag: 44<br />acf: 0.038563908","lag: 45<br />acf: 0.044674898","lag: 46<br />acf: 0.067557819","lag: 47<br />acf: 0.058133734","lag: 48<br />acf: 0.076701570","lag: 49<br />acf: 0.051474538","lag: 50<br />acf: 0.024721017","lag: 51<br />acf: 0.028668265","lag: 52<br />acf: 0.100682391"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(70,130,180,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-3.0950000000000006,55.095000000000006,null,-3.0950000000000006,55.095000000000006],"y":[-0.19600000000000001,-0.19600000000000001,null,0.19600000000000001,0.19600000000000001],"text":["yintercept: -0.196","yintercept: -0.196",null,"yintercept:  0.196","yintercept:  0.196"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(255,0,0,1)","dash":"dash"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":43.762557077625573,"r":7.3059360730593621,"b":40.182648401826498,"l":54.794520547945211},"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"title":{"text":"ACF for Model B","font":{"color":"rgba(0,0,0,1)","family":"","size":17.534246575342465},"x":0,"xref":"paper"},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-3.0950000000000006,55.095000000000006],"tickmode":"array","ticktext":["0","10","20","30","40","50"],"tickvals":[0,10,20,30,40,50],"categoryorder":"array","categoryarray":["0","10","20","30","40","50"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":{"text":"Lag","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.27925177768021231,1.0609167513181053],"tickmode":"array","ticktext":["-0.25","0.00","0.25","0.50","0.75","1.00"],"tickvals":[-0.25,0,0.25000000000000006,0.5,0.75,1],"categoryorder":"array","categoryarray":["-0.25","0.00","0.25","0.50","0.75","1.00"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"x","title":{"text":"ACF","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":false,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"800156b429f9":{"x":{},"y":{},"type":"bar"},"80014e2fc6e7":{"yintercept":{}}},"cur_data":"800156b429f9","visdat":{"800156b429f9":["function (y) ","x"],"80014e2fc6e7":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="plot-partial-autocorrelation-function-pacf-residuals-1" class="level3" data-number="13.2.4">
<h3 data-number="13.2.4" class="anchored" data-anchor-id="plot-partial-autocorrelation-function-pacf-residuals-1"><span class="header-section-number">13.2.4</span> Plot <strong>Partial Autocorrelation Function</strong> PACF residuals</h3>
<p>PACF (Partial Autocorrelation Function)&nbsp;is used to determine the appropriate value for the&nbsp;Autoregressive (AR)&nbsp;order&nbsp;<code>p</code>&nbsp;in an&nbsp;ARIMA&nbsp;model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pacf_b, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>threshold, threshold), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> model) <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PACF Model B"</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lag"</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"PACF"</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-8e1fe96c0688a849169a" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-8e1fe96c0688a849169a">{"x":{"data":[{"orientation":"v","width":[0.89999999999999991,0.90000000000000013,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.89999999999999947,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.90000000000000213,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568],"base":[-0.0094025597297207452,-0.053206006768538962,0,0,0,0,-0.033480778549576047,-0.055923477292848661,-0.047951296653234922,-0.22938770418551971,-0.13121826391778518,0,-0.003879237557174313,-0.13007554715488104,-0.18688553457702725,-0.012269648317450888,-0.12510464534053345,-0.00063825171674514051,-0.017499948047415601,0,-0.091328646704639221,0,-0.035359279690106979,-0.16201870525605777,0,-0.09521496658592779,-0.089894565149196651,0,0,-0.15951889671528013,-0.051669426554972149,0,0,-0.030707793630571224,-0.026592557358923501,-0.039058219836448457,-0.014129978529018336,0,-0.019215602405733077,-0.053461557415658147,0,0,0,0,-0.075421701919353268,-0.070857372645529951,0,-0.036578852252346285,-0.014625753199713657,-0.097988287819421774,0,-0.0035122168249599357],"x":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52],"y":[0.0094025597297207452,0.053206006768538962,0.043917702282149196,0.088596831532550574,0.10945221571780947,0.094906922354914769,0.033480778549576047,0.055923477292848661,0.047951296653234922,0.22938770418551971,0.13121826391778518,0.014003716540793682,0.003879237557174313,0.13007554715488104,0.18688553457702725,0.012269648317450888,0.12510464534053345,0.00063825171674514051,0.017499948047415601,0.018997237883431651,0.091328646704639221,0.024064755511787574,0.035359279690106979,0.16201870525605777,0.092311562443831638,0.09521496658592779,0.089894565149196651,0.04487245771929383,0.058052000433338982,0.15951889671528013,0.051669426554972149,0.028636900998769921,0.028858020687083343,0.030707793630571224,0.026592557358923501,0.039058219836448457,0.014129978529018336,0.026731843719023127,0.019215602405733077,0.053461557415658147,0.05924692976792257,0.12354526796748418,0.033536516884922665,0.082908621907056446,0.075421701919353268,0.070857372645529951,0.018272561503669189,0.036578852252346285,0.014625753199713657,0.097988287819421774,0.025336543707573267,0.0035122168249599357],"text":["lag:  1<br />acf: 0.0094025597","lag:  2<br />acf: 0.0532060068","lag:  3<br />acf: 0.0439177023","lag:  4<br />acf: 0.0885968315","lag:  5<br />acf: 0.1094522157","lag:  6<br />acf: 0.0949069224","lag:  7<br />acf: 0.0334807785","lag:  8<br />acf: 0.0559234773","lag:  9<br />acf: 0.0479512967","lag: 10<br />acf: 0.2293877042","lag: 11<br />acf: 0.1312182639","lag: 12<br />acf: 0.0140037165","lag: 13<br />acf: 0.0038792376","lag: 14<br />acf: 0.1300755472","lag: 15<br />acf: 0.1868855346","lag: 16<br />acf: 0.0122696483","lag: 17<br />acf: 0.1251046453","lag: 18<br />acf: 0.0006382517","lag: 19<br />acf: 0.0174999480","lag: 20<br />acf: 0.0189972379","lag: 21<br />acf: 0.0913286467","lag: 22<br />acf: 0.0240647555","lag: 23<br />acf: 0.0353592797","lag: 24<br />acf: 0.1620187053","lag: 25<br />acf: 0.0923115624","lag: 26<br />acf: 0.0952149666","lag: 27<br />acf: 0.0898945651","lag: 28<br />acf: 0.0448724577","lag: 29<br />acf: 0.0580520004","lag: 30<br />acf: 0.1595188967","lag: 31<br />acf: 0.0516694266","lag: 32<br />acf: 0.0286369010","lag: 33<br />acf: 0.0288580207","lag: 34<br />acf: 0.0307077936","lag: 35<br />acf: 0.0265925574","lag: 36<br />acf: 0.0390582198","lag: 37<br />acf: 0.0141299785","lag: 38<br />acf: 0.0267318437","lag: 39<br />acf: 0.0192156024","lag: 40<br />acf: 0.0534615574","lag: 41<br />acf: 0.0592469298","lag: 42<br />acf: 0.1235452680","lag: 43<br />acf: 0.0335365169","lag: 44<br />acf: 0.0829086219","lag: 45<br />acf: 0.0754217019","lag: 46<br />acf: 0.0708573726","lag: 47<br />acf: 0.0182725615","lag: 48<br />acf: 0.0365788523","lag: 49<br />acf: 0.0146257532","lag: 50<br />acf: 0.0979882878","lag: 51<br />acf: 0.0253365437","lag: 52<br />acf: 0.0035122168"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(70,130,180,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-2.0450000000000008,55.045000000000002,null,-2.0450000000000008,55.045000000000002],"y":[-0.19600000000000001,-0.19600000000000001,null,0.19600000000000001,0.19600000000000001],"text":["yintercept: -0.196","yintercept: -0.196",null,"yintercept:  0.196","yintercept:  0.196"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(255,0,0,1)","dash":"dash"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":55.452054794520549,"r":7.3059360730593621,"b":40.182648401826498,"l":48.949771689497723},"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"title":{"text":"PACF Model B","font":{"color":"rgba(0,0,0,1)","family":"","size":17.534246575342465},"x":0,"xref":"paper"},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-2.0450000000000008,55.045000000000002],"tickmode":"array","ticktext":["0","10","20","30","40","50"],"tickvals":[0,10,20,30,40,50],"categoryorder":"array","categoryarray":["0","10","20","30","40","50"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":"","hoverformat":".2f"},"annotations":[{"text":"Lag","x":0.5,"y":0,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"top","annotationType":"axis","yshift":-21.917808219178081},{"text":"PACF","x":0,"y":0.5,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-90,"xanchor":"right","yanchor":"center","annotationType":"axis","xshift":-33.607305936073068},{"text":"Model B","x":0.5,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.68949771689498},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"}],"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.2506570893947957,0.21726938520927599],"tickmode":"array","ticktext":["-0.2","-0.1","0.0","0.1","0.2"],"tickvals":[-0.20000000000000001,-0.10000000000000001,0,0.10000000000000003,0.20000000000000001],"categoryorder":"array","categoryarray":["-0.2","-0.1","0.0","0.1","0.2"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"x","title":"","hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":23.37899543378996,"yanchor":1,"ysizemode":"pixel"}],"showlegend":false,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"8001433cbddb":{"x":{},"y":{},"type":"bar"},"800148d49759":{"yintercept":{}}},"cur_data":"8001433cbddb","visdat":{"8001433cbddb":["function (y) ","x"],"800148d49759":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="a-more-exhaustive-search-for-the-best-autocorrelation-values" class="level3" data-number="13.2.5">
<h3 data-number="13.2.5" class="anchored" data-anchor-id="a-more-exhaustive-search-for-the-best-autocorrelation-values"><span class="header-section-number">13.2.5</span> A More Exhaustive search for the best autocorrelation values</h3>
<p>Using our empirically determined values of p and q seem to have helped a little, but there’s still a significant autocorrelation at lag 15 in the ACF plot and a significant spike at PACF lag 10.</p>
<p>What I often do here is to apply an exhaustive search of all combinations of values of p and q to the gls model that might be sifnificant, capturing the value of the Akaike Information Criterion (AIC) and Bayesian Information Criterion (BIC) for each model. Whichever combination of values of p and q returns the smallest AIC value is the best fit for our modelling.</p>
<p>Realistically there’s some margin for human biases here. It’s hard to exactly define good numbers to put in to this analysis. I’d recommend a broad range of values because sometime autocorrelations can be quite lagged. In this case, it’s clear that something is going on as far as p=10 and q=10 because both ACF and PACF plots have a spike at lag 10.</p>
<p>Our start point is the AIC value of the model we ran earlier where neither p or q were specified (i.e.&nbsp;no autocorrelation)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">summary</span>(<span class="fu">gls</span>(mod<span class="fl">.1</span>, <span class="at">data =</span> df,<span class="at">method=</span><span class="st">"ML"</span>))<span class="sc">$</span>AIC</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">str_c</span> (<span class="st">"AIC Uncorrelated model = "</span>,p))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>AIC Uncorrelated model = 1049.8908715391</code></pre>
</div>
</div>
<p>Next we can create a grid of combinations of values of p and q</p>
<p>Above we can see that sensible values of q might be 0,1,2,10,14,15 and 25. Meanwhile sensible values of p might be 0,1,2,10 and 15</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>autocorrel <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">qval =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">10</span>,<span class="dv">14</span>,<span class="dv">15</span>,<span class="dv">25</span>), <span class="at">pval =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">10</span>,<span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we apply the function to all possible combinations of p and q. Expect some not to work with this dummy data set because the models won’t all converge. You can fiddle with the settings to increase the number of iterations if you have issues with non-convergence. This may also take a while as there’s lots of computations happening. For the sake of illustration, I’m going to remove the ones which don’t converge from this example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase the number of iterations for the optimization process</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>control <span class="ot">&lt;-</span> nlme<span class="sc">::</span><span class="fu">glsControl</span>(<span class="at">maxIter =</span> <span class="dv">1500</span>, <span class="at">msMaxIter =</span> <span class="dv">1500</span>)  <span class="co"># Adjust max iterations as needed</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">nrow</span>(autocorrel)) {</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">try</span>({</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">gls</span>(mod<span class="fl">.1</span>, <span class="at">data =</span> df, <span class="at">correlation =</span> <span class="fu">corARMA</span>(<span class="at">p =</span> autocorrel<span class="sc">$</span>pval[i], <span class="at">q =</span> autocorrel<span class="sc">$</span>qval[i], <span class="at">form =</span> <span class="sc">~</span> Time), <span class="at">method =</span> <span class="st">"ML"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    autocorrel<span class="sc">$</span>BIC[i] <span class="ot">&lt;-</span> <span class="fu">AIC</span>(model, <span class="at">k =</span> <span class="fu">log</span>(<span class="fu">nrow</span>(df)))  <span class="co"># Calculate BIC using AIC function</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    autocorrel<span class="sc">$</span>AIC[i] <span class="ot">&lt;-</span> <span class="fu">AIC</span>(model)  <span class="co"># Calculate AIC directly</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in `$&lt;-.data.frame`(`*tmp*`, "BIC", value = c(NA, 1060.5897436766 : 
  replacement has 2 rows, data has 35
Error in `$&lt;-.data.frame`(`*tmp*`, "BIC", value = c(NA, NA, 1057.94350685086 : 
  replacement has 3 rows, data has 35
Error in `$&lt;-.data.frame`(`*tmp*`, "BIC", value = c(NA, NA, NA, 1081.84593352225 : 
  replacement has 4 rows, data has 35
Error in gls(mod.1, data = df, correlation = corARMA(p = autocorrel$pval[i],  : 
  function evaluation limit reached without convergence (9)
Error in `coef&lt;-.corARMA`(`*tmp*`, value = value[parMap[, i]]) : 
  NA/NaN/Inf in foreign function call (arg 1)
Error in `coef&lt;-.corARMA`(`*tmp*`, value = value[parMap[, i]]) : 
  NA/NaN/Inf in foreign function call (arg 1)
Error in `coef&lt;-.corARMA`(`*tmp*`, value = value[parMap[, i]]) : 
  NA/NaN/Inf in foreign function call (arg 1)
Error in gls(mod.1, data = df, correlation = corARMA(p = autocorrel$pval[i],  : 
  false convergence (8)
Error in `coef&lt;-.corARMA`(`*tmp*`, value = value[parMap[, i]]) : 
  NA/NaN/Inf in foreign function call (arg 1)
Error in `coef&lt;-.corARMA`(`*tmp*`, value = value[parMap[, i]]) : 
  NA/NaN/Inf in foreign function call (arg 1)
Error in `coef&lt;-.corARMA`(`*tmp*`, value = value[parMap[, i]]) : 
  NA/NaN/Inf in foreign function call (arg 1)
Error in `coef&lt;-.corARMA`(`*tmp*`, value = value[parMap[, i]]) : 
  NA/NaN/Inf in foreign function call (arg 1)
Error in gls(mod.1, data = df, correlation = corARMA(p = autocorrel$pval[i],  : 
  function evaluation limit reached without convergence (9)
Error in `coef&lt;-.corARMA`(`*tmp*`, value = value[parMap[, i]]) : 
  NA/NaN/Inf in foreign function call (arg 1)
Error in `coef&lt;-.corARMA`(`*tmp*`, value = value[parMap[, i]]) : 
  NA/NaN/Inf in foreign function call (arg 1)
Error in gls(mod.1, data = df, correlation = corARMA(p = autocorrel$pval[i],  : 
  false convergence (8)
Error in gls(mod.1, data = df, correlation = corARMA(p = autocorrel$pval[i],  : 
  function evaluation limit reached without convergence (9)
Error in gls(mod.1, data = df, correlation = corARMA(p = autocorrel$pval[i],  : 
  function evaluation limit reached without convergence (9)
Error in gls(mod.1, data = df, correlation = corARMA(p = autocorrel$pval[i],  : 
  false convergence (8)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with NA in BIC or AIC</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">#autocorrel &lt;- autocorrel %&gt;% filter(!is.na(BIC), !is.na(AIC))</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>autocorrel </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   qval pval      BIC      AIC
1     0    0       NA       NA
2     1    0       NA       NA
3     2    0       NA       NA
4    10    0       NA       NA
5    14    0 1096.567 1047.069
6    15    0 1100.903 1048.800
7    25    0       NA       NA
8     0    1 1064.656 1049.025
9     1    1 1055.094 1036.858
10    2    1 1062.361 1041.519
11   10    1       NA       NA
12   14    1       NA       NA
13   15    1       NA       NA
14   25    1       NA       NA
15    0    2 1059.878 1041.642
16    1    2 1062.179 1041.337
17    2    2 1061.106 1037.660
18   10    2       NA       NA
19   14    2       NA       NA
20   15    2 1096.567 1047.069
21   25    2       NA       NA
22    0   10 1087.249 1048.171
23    1   10 1081.233 1039.551
24    2   10 1085.379 1041.091
25   10   10 1096.567 1047.069
26   14   10       NA       NA
27   15   10       NA       NA
28   25   10       NA       NA
29    0   15 1105.131 1053.028
30    1   15 1095.635 1040.926
31    2   15 1092.984 1035.670
32   10   15       NA       NA
33   14   15 1133.788 1045.212
34   15   15       NA       NA
35   25   15 1096.567 1047.069</code></pre>
</div>
</div>
</section>
<section id="show-the-aic-vs-bic" class="level3" data-number="13.2.6">
<h3 data-number="13.2.6" class="anchored" data-anchor-id="show-the-aic-vs-bic"><span class="header-section-number">13.2.6</span> Show the AIC vs BIC</h3>
<p>Choose one which has low values for both dimensions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(autocorrel, <span class="fu">aes</span>(AIC, BIC, <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"p="</span>, pval, <span class="st">" q="</span>, qval))) <span class="sc">+</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-bb3486349adfa5d821dc" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-bb3486349adfa5d821dc">{"x":{"data":[{"x":[null,null,null,null,1047.0685479748124,1048.7996946293215,null,1049.0253801147994,1036.8581637448069,1041.5191481590473,null,null,null,null,1041.6421017660982,1041.3373810157545,1037.6595796808995,null,null,1047.0685479748124,null,1048.1710957496664,1039.550776442044,1041.0914780401654,1047.0685479748124,null,null,null,1053.027563051184,1040.9264248782245,1035.6701213329363,null,1045.2122852871587,null,1047.0685479748124],"y":[null,null,null,null,1096.5667815085862,1100.9030983490834,null,1064.6564012307281,1055.0943550467236,1062.3605096469521,null,null,null,null,1059.878293068015,1062.1787425036594,1061.1061113547923,null,null,1096.5667815085862,null,1087.2486485394877,1081.2334994178534,1085.3793712019628,1096.5667815085862,null,null,null,1105.1309667709459,1095.6349987839744,1092.9838654246744,null,1133.7880716107538,null,1096.5667815085862],"text":["AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 0  q= 0","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 0  q= 1","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 0  q= 2","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 0  q= 10","AIC: 1047.069<br />BIC: 1096.567<br />paste(\"p=\", pval, \" q=\", qval): p= 0  q= 14","AIC: 1048.800<br />BIC: 1100.903<br />paste(\"p=\", pval, \" q=\", qval): p= 0  q= 15","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 0  q= 25","AIC: 1049.025<br />BIC: 1064.656<br />paste(\"p=\", pval, \" q=\", qval): p= 1  q= 0","AIC: 1036.858<br />BIC: 1055.094<br />paste(\"p=\", pval, \" q=\", qval): p= 1  q= 1","AIC: 1041.519<br />BIC: 1062.361<br />paste(\"p=\", pval, \" q=\", qval): p= 1  q= 2","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 1  q= 10","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 1  q= 14","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 1  q= 15","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 1  q= 25","AIC: 1041.642<br />BIC: 1059.878<br />paste(\"p=\", pval, \" q=\", qval): p= 2  q= 0","AIC: 1041.337<br />BIC: 1062.179<br />paste(\"p=\", pval, \" q=\", qval): p= 2  q= 1","AIC: 1037.660<br />BIC: 1061.106<br />paste(\"p=\", pval, \" q=\", qval): p= 2  q= 2","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 2  q= 10","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 2  q= 14","AIC: 1047.069<br />BIC: 1096.567<br />paste(\"p=\", pval, \" q=\", qval): p= 2  q= 15","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 2  q= 25","AIC: 1048.171<br />BIC: 1087.249<br />paste(\"p=\", pval, \" q=\", qval): p= 10  q= 0","AIC: 1039.551<br />BIC: 1081.233<br />paste(\"p=\", pval, \" q=\", qval): p= 10  q= 1","AIC: 1041.091<br />BIC: 1085.379<br />paste(\"p=\", pval, \" q=\", qval): p= 10  q= 2","AIC: 1047.069<br />BIC: 1096.567<br />paste(\"p=\", pval, \" q=\", qval): p= 10  q= 10","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 10  q= 14","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 10  q= 15","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 10  q= 25","AIC: 1053.028<br />BIC: 1105.131<br />paste(\"p=\", pval, \" q=\", qval): p= 15  q= 0","AIC: 1040.926<br />BIC: 1095.635<br />paste(\"p=\", pval, \" q=\", qval): p= 15  q= 1","AIC: 1035.670<br />BIC: 1092.984<br />paste(\"p=\", pval, \" q=\", qval): p= 15  q= 2","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 15  q= 10","AIC: 1045.212<br />BIC: 1133.788<br />paste(\"p=\", pval, \" q=\", qval): p= 15  q= 14","AIC:       NA<br />BIC:       NA<br />paste(\"p=\", pval, \" q=\", qval): p= 15  q= 15","AIC: 1047.069<br />BIC: 1096.567<br />paste(\"p=\", pval, \" q=\", qval): p= 15  q= 25"],"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,0,0,1)","opacity":1,"size":5.6692913385826778,"symbol":"circle","line":{"width":1.8897637795275593,"color":"rgba(0,0,0,1)"}},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":26.228310502283108,"r":7.3059360730593621,"b":40.182648401826498,"l":48.949771689497723},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[1034.8022492470241,1053.8954351370962],"tickmode":"array","ticktext":["1035","1040","1045","1050"],"tickvals":[1035,1040,1045,1050],"categoryorder":"array","categoryarray":["1035","1040","1045","1050"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.6529680365296811,"tickwidth":0.66417600664176002,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":{"text":"AIC","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[1051.1596692185221,1137.7227574389553],"tickmode":"array","ticktext":["1060","1080","1100","1120"],"tickvals":[1060,1080,1100,1120],"categoryorder":"array","categoryarray":["1060","1080","1100","1120"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.6529680365296811,"tickwidth":0.66417600664176002,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"x","title":{"text":"BIC","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":false,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.8897637795275593,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"80011eaaf225":{"x":{},"y":{},"label":{},"type":"scatter"}},"cur_data":"80011eaaf225","visdat":{"80011eaaf225":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Here, there’s models which are more predictive (i.e.&nbsp;AIC is lower) but which have relatively higher potential for overfitting (BIC is higher) and vice versa. I think I’m going to go with p=1, q=1 as this balances the two priorities and seems to be the best overall combination</p>
<p>Let’s see what effect that has on our model by making a new model.c and comparing it to the original model.a and p=2,q=2 (model.b)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>model.c <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> Time <span class="sc">+</span> Intervention <span class="sc">+</span> Post.intervention.time, <span class="at">data =</span> df,<span class="at">method=</span><span class="st">"ML"</span>, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">1</span>,<span class="at">q=</span><span class="dv">1</span>, <span class="at">form =</span> <span class="sc">~</span> Time))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="check-the-residuals" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="check-the-residuals"><span class="header-section-number">13.3</span> Check the residuals</h2>
<p>Adding residual diagnostics can help confirm that the model adequately captures the dynamics of the data. Let’s add residual checks to ensure our assumptions hold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract normalized residuals from the models</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>residuals_a <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model.a, <span class="at">type =</span> <span class="st">'normalized'</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>residuals_b <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model.b, <span class="at">type =</span> <span class="st">'normalized'</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>residuals_c <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model.c, <span class="at">type =</span> <span class="st">'normalized'</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the maximum lag for the autocorrelation and partial autocorrelation functions</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>max_lag <span class="ot">&lt;-</span> <span class="dv">52</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get ACF and PACF data for both models</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>acf_a <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_a, max_lag, <span class="st">"acf"</span>, <span class="st">"Model A"</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>pacf_a <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_a, max_lag, <span class="st">"pacf"</span>, <span class="st">"Model A"</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>acf_b <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_b, max_lag, <span class="st">"acf"</span>, <span class="st">"Model B"</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>pacf_b <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_b, max_lag, <span class="st">"pacf"</span>, <span class="st">"Model B"</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>acf_c <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_c, max_lag, <span class="st">"acf"</span>, <span class="st">"Model c"</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>pacf_c <span class="ot">&lt;-</span> <span class="fu">get_acf_pacf</span>(residuals_c, max_lag, <span class="st">"pacf"</span>, <span class="st">"Model c"</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all data into a single dataframe</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>acf_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(acf_a, acf_b,acf_c)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>pacf_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pacf_a, pacf_b,pacf_c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot <strong>Autocorrelation Function</strong> ACF residuals</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(acf_data, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>threshold, threshold), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> model) <span class="sc">+</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"ACF for Models A, B and C"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lag"</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"ACF"</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Interrupted_Time_Series_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can see that there’s relatively little difference between model.b and model.c</p>
<section id="plot-partial-autocorrelation-function-pacf-residuals-2" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="plot-partial-autocorrelation-function-pacf-residuals-2"><span class="header-section-number">13.3.1</span> Plot <strong>Partial Autocorrelation Function</strong> PACF residuals</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pacf_data, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span>threshold, threshold), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> model) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PACF for Models A, B and C"</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Lag"</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"ACF"</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item" id="htmlwidget-44474b3e8cd160f85a98" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-44474b3e8cd160f85a98">{"x":{"data":[{"orientation":"v","width":[0.89999999999999991,0.90000000000000013,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.89999999999999947,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.90000000000000213,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568],"base":[-0.166098539112007,-0.29060019478463878,-0.11019231354588904,-0.11044813772576276,0,0,0,-0.0069529205189665473,0,-0.19522052581551896,-0.067465579512533527,-0.0065830534285992292,0,-0.11140188324557355,-0.1051312199239349,-0.034904708162389345,-0.097785902554745535,-0.044296973822100343,-0.028607816180746364,0,-0.11044205191440767,0,-0.020321448997980354,-0.14401290019103147,0,-0.063931239544753077,-0.08427283981971391,0,0,-0.15402987166339746,-0.073842925800364459,-0.0090657953029595617,0,-0.026131348459856828,0,-0.061984893812730375,-0.029854573589143639,-0.0087795752590108696,-0.044030127942692308,-0.14341509187984749,-0.019197777417986082,0,0,0,-0.060710548659088988,-0.080335753977233915,-0.0078716433762441671,-0.037831005970534175,-0.018171572091294767,-0.13740837777508058,-0.022510732413462721,-0.052306546822607727],"x":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52],"y":[0.166098539112007,0.29060019478463878,0.11019231354588904,0.11044813772576276,0.056417204657661049,0.049885759882867316,0.057977829245226806,0.0069529205189665473,0.096299203066017719,0.19522052581551896,0.067465579512533527,0.0065830534285992292,0.097311377594084564,0.11140188324557355,0.1051312199239349,0.034904708162389345,0.097785902554745535,0.044296973822100343,0.028607816180746364,0.0019268228747075175,0.11044205191440767,0.033131461602787821,0.020321448997980354,0.14401290019103147,0.10994907917292915,0.063931239544753077,0.08427283981971391,0.033368280611581619,0.081851630171081532,0.15402987166339746,0.073842925800364459,0.0090657953029595617,0.053090034830077848,0.026131348459856828,0.0056144182050972069,0.061984893812730375,0.029854573589143639,0.0087795752590108696,0.044030127942692308,0.14341509187984749,0.019197777417986082,0.065751193146626294,0.022624669072824993,0.087989953152190478,0.060710548659088988,0.080335753977233915,0.0078716433762441671,0.037831005970534175,0.018171572091294767,0.13740837777508058,0.022510732413462721,0.052306546822607727],"text":["lag:  1<br />acf: 0.1660985391","lag:  2<br />acf: 0.2906001948","lag:  3<br />acf: 0.1101923135","lag:  4<br />acf: 0.1104481377","lag:  5<br />acf: 0.0564172047","lag:  6<br />acf: 0.0498857599","lag:  7<br />acf: 0.0579778292","lag:  8<br />acf: 0.0069529205","lag:  9<br />acf: 0.0962992031","lag: 10<br />acf: 0.1952205258","lag: 11<br />acf: 0.0674655795","lag: 12<br />acf: 0.0065830534","lag: 13<br />acf: 0.0973113776","lag: 14<br />acf: 0.1114018832","lag: 15<br />acf: 0.1051312199","lag: 16<br />acf: 0.0349047082","lag: 17<br />acf: 0.0977859026","lag: 18<br />acf: 0.0442969738","lag: 19<br />acf: 0.0286078162","lag: 20<br />acf: 0.0019268229","lag: 21<br />acf: 0.1104420519","lag: 22<br />acf: 0.0331314616","lag: 23<br />acf: 0.0203214490","lag: 24<br />acf: 0.1440129002","lag: 25<br />acf: 0.1099490792","lag: 26<br />acf: 0.0639312395","lag: 27<br />acf: 0.0842728398","lag: 28<br />acf: 0.0333682806","lag: 29<br />acf: 0.0818516302","lag: 30<br />acf: 0.1540298717","lag: 31<br />acf: 0.0738429258","lag: 32<br />acf: 0.0090657953","lag: 33<br />acf: 0.0530900348","lag: 34<br />acf: 0.0261313485","lag: 35<br />acf: 0.0056144182","lag: 36<br />acf: 0.0619848938","lag: 37<br />acf: 0.0298545736","lag: 38<br />acf: 0.0087795753","lag: 39<br />acf: 0.0440301279","lag: 40<br />acf: 0.1434150919","lag: 41<br />acf: 0.0191977774","lag: 42<br />acf: 0.0657511931","lag: 43<br />acf: 0.0226246691","lag: 44<br />acf: 0.0879899532","lag: 45<br />acf: 0.0607105487","lag: 46<br />acf: 0.0803357540","lag: 47<br />acf: 0.0078716434","lag: 48<br />acf: 0.0378310060","lag: 49<br />acf: 0.0181715721","lag: 50<br />acf: 0.1374083778","lag: 51<br />acf: 0.0225107324","lag: 52<br />acf: 0.0523065468"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(70,130,180,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":[0.89999999999999991,0.90000000000000013,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.89999999999999947,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.90000000000000213,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568],"base":[-0.0094025597297207452,-0.053206006768538962,0,0,0,0,-0.033480778549576047,-0.055923477292848661,-0.047951296653234922,-0.22938770418551971,-0.13121826391778518,0,-0.003879237557174313,-0.13007554715488104,-0.18688553457702725,-0.012269648317450888,-0.12510464534053345,-0.00063825171674514051,-0.017499948047415601,0,-0.091328646704639221,0,-0.035359279690106979,-0.16201870525605777,0,-0.09521496658592779,-0.089894565149196651,0,0,-0.15951889671528013,-0.051669426554972149,0,0,-0.030707793630571224,-0.026592557358923501,-0.039058219836448457,-0.014129978529018336,0,-0.019215602405733077,-0.053461557415658147,0,0,0,0,-0.075421701919353268,-0.070857372645529951,0,-0.036578852252346285,-0.014625753199713657,-0.097988287819421774,0,-0.0035122168249599357],"x":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52],"y":[0.0094025597297207452,0.053206006768538962,0.043917702282149196,0.088596831532550574,0.10945221571780947,0.094906922354914769,0.033480778549576047,0.055923477292848661,0.047951296653234922,0.22938770418551971,0.13121826391778518,0.014003716540793682,0.003879237557174313,0.13007554715488104,0.18688553457702725,0.012269648317450888,0.12510464534053345,0.00063825171674514051,0.017499948047415601,0.018997237883431651,0.091328646704639221,0.024064755511787574,0.035359279690106979,0.16201870525605777,0.092311562443831638,0.09521496658592779,0.089894565149196651,0.04487245771929383,0.058052000433338982,0.15951889671528013,0.051669426554972149,0.028636900998769921,0.028858020687083343,0.030707793630571224,0.026592557358923501,0.039058219836448457,0.014129978529018336,0.026731843719023127,0.019215602405733077,0.053461557415658147,0.05924692976792257,0.12354526796748418,0.033536516884922665,0.082908621907056446,0.075421701919353268,0.070857372645529951,0.018272561503669189,0.036578852252346285,0.014625753199713657,0.097988287819421774,0.025336543707573267,0.0035122168249599357],"text":["lag:  1<br />acf: 0.0094025597","lag:  2<br />acf: 0.0532060068","lag:  3<br />acf: 0.0439177023","lag:  4<br />acf: 0.0885968315","lag:  5<br />acf: 0.1094522157","lag:  6<br />acf: 0.0949069224","lag:  7<br />acf: 0.0334807785","lag:  8<br />acf: 0.0559234773","lag:  9<br />acf: 0.0479512967","lag: 10<br />acf: 0.2293877042","lag: 11<br />acf: 0.1312182639","lag: 12<br />acf: 0.0140037165","lag: 13<br />acf: 0.0038792376","lag: 14<br />acf: 0.1300755472","lag: 15<br />acf: 0.1868855346","lag: 16<br />acf: 0.0122696483","lag: 17<br />acf: 0.1251046453","lag: 18<br />acf: 0.0006382517","lag: 19<br />acf: 0.0174999480","lag: 20<br />acf: 0.0189972379","lag: 21<br />acf: 0.0913286467","lag: 22<br />acf: 0.0240647555","lag: 23<br />acf: 0.0353592797","lag: 24<br />acf: 0.1620187053","lag: 25<br />acf: 0.0923115624","lag: 26<br />acf: 0.0952149666","lag: 27<br />acf: 0.0898945651","lag: 28<br />acf: 0.0448724577","lag: 29<br />acf: 0.0580520004","lag: 30<br />acf: 0.1595188967","lag: 31<br />acf: 0.0516694266","lag: 32<br />acf: 0.0286369010","lag: 33<br />acf: 0.0288580207","lag: 34<br />acf: 0.0307077936","lag: 35<br />acf: 0.0265925574","lag: 36<br />acf: 0.0390582198","lag: 37<br />acf: 0.0141299785","lag: 38<br />acf: 0.0267318437","lag: 39<br />acf: 0.0192156024","lag: 40<br />acf: 0.0534615574","lag: 41<br />acf: 0.0592469298","lag: 42<br />acf: 0.1235452680","lag: 43<br />acf: 0.0335365169","lag: 44<br />acf: 0.0829086219","lag: 45<br />acf: 0.0754217019","lag: 46<br />acf: 0.0708573726","lag: 47<br />acf: 0.0182725615","lag: 48<br />acf: 0.0365788523","lag: 49<br />acf: 0.0146257532","lag: 50<br />acf: 0.0979882878","lag: 51<br />acf: 0.0253365437","lag: 52<br />acf: 0.0035122168"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(70,130,180,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"showlegend":false,"xaxis":"x2","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":[0.89999999999999991,0.90000000000000013,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.89999999999999947,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.89999999999999858,0.90000000000000213,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568,0.90000000000000568],"base":[0,-0.10829021267003301,0,0,0,0,0,-0.081304898516147667,-0.010026667755830424,-0.26758999395191785,-0.082713349908894854,-0.028114747423052252,0,-0.17649346921940162,-0.14053097873870593,-0.049930992866683246,-0.10059119012670938,-0.021651898396176428,-0.0033311994827708497,0,-0.08888325920149738,0,-0.046558872072469906,-0.15003681399655586,0,-0.10553576040845766,-0.079708594571344465,0,0,-0.16867653810838582,-0.034439661617289216,0,0,-0.045821976517645989,-0.0093842177201176446,-0.056537395277753491,0,0,-0.008047513055548362,-0.069978819585138338,0,0,0,0,-0.07787169015893812,-0.065200424174933214,0,-0.037621921991558359,-0.017902065853646721,-0.10677484295686465,0,-0.016773647506143696],"x":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52],"y":[0.014329698696050065,0.10829021267003301,0.079950860112700126,0.043040934840037015,0.14920571549475017,0.059771085836865287,0.0050391239693945633,0.081304898516147667,0.010026667755830424,0.26758999395191785,0.082713349908894854,0.028114747423052252,0.037125186394446313,0.17649346921940162,0.14053097873870593,0.049930992866683246,0.10059119012670938,0.021651898396176428,0.0033311994827708497,0.0082684828938734134,0.08888325920149738,0.035756553189733011,0.046558872072469906,0.15003681399655586,0.096715621226038037,0.10553576040845766,0.079708594571344465,0.042323092067552255,0.061445246471847327,0.16867653810838582,0.034439661617289216,0.016283688818380639,0.042049704608552181,0.045821976517645989,0.0093842177201176446,0.056537395277753491,0.0018269035773931634,0.012163361572997378,0.008047513055548362,0.069978819585138338,0.076550515246300688,0.10838189507388206,0.044348223631541894,0.079969932092644275,0.07787169015893812,0.065200424174933214,0.0152443625820188,0.037621921991558359,0.017902065853646721,0.10677484295686465,0.0310527370442099,0.016773647506143696],"text":["lag:  1<br />acf: 0.0143296987","lag:  2<br />acf: 0.1082902127","lag:  3<br />acf: 0.0799508601","lag:  4<br />acf: 0.0430409348","lag:  5<br />acf: 0.1492057155","lag:  6<br />acf: 0.0597710858","lag:  7<br />acf: 0.0050391240","lag:  8<br />acf: 0.0813048985","lag:  9<br />acf: 0.0100266678","lag: 10<br />acf: 0.2675899940","lag: 11<br />acf: 0.0827133499","lag: 12<br />acf: 0.0281147474","lag: 13<br />acf: 0.0371251864","lag: 14<br />acf: 0.1764934692","lag: 15<br />acf: 0.1405309787","lag: 16<br />acf: 0.0499309929","lag: 17<br />acf: 0.1005911901","lag: 18<br />acf: 0.0216518984","lag: 19<br />acf: 0.0033311995","lag: 20<br />acf: 0.0082684829","lag: 21<br />acf: 0.0888832592","lag: 22<br />acf: 0.0357565532","lag: 23<br />acf: 0.0465588721","lag: 24<br />acf: 0.1500368140","lag: 25<br />acf: 0.0967156212","lag: 26<br />acf: 0.1055357604","lag: 27<br />acf: 0.0797085946","lag: 28<br />acf: 0.0423230921","lag: 29<br />acf: 0.0614452465","lag: 30<br />acf: 0.1686765381","lag: 31<br />acf: 0.0344396616","lag: 32<br />acf: 0.0162836888","lag: 33<br />acf: 0.0420497046","lag: 34<br />acf: 0.0458219765","lag: 35<br />acf: 0.0093842177","lag: 36<br />acf: 0.0565373953","lag: 37<br />acf: 0.0018269036","lag: 38<br />acf: 0.0121633616","lag: 39<br />acf: 0.0080475131","lag: 40<br />acf: 0.0699788196","lag: 41<br />acf: 0.0765505152","lag: 42<br />acf: 0.1083818951","lag: 43<br />acf: 0.0443482236","lag: 44<br />acf: 0.0799699321","lag: 45<br />acf: 0.0778716902","lag: 46<br />acf: 0.0652004242","lag: 47<br />acf: 0.0152443626","lag: 48<br />acf: 0.0376219220","lag: 49<br />acf: 0.0179020659","lag: 50<br />acf: 0.1067748430","lag: 51<br />acf: 0.0310527370","lag: 52<br />acf: 0.0167736475"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(70,130,180,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"showlegend":false,"xaxis":"x3","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-2.0450000000000008,55.045000000000002,null,-2.0450000000000008,55.045000000000002],"y":[-0.19600000000000001,-0.19600000000000001,null,0.19600000000000001,0.19600000000000001],"text":["yintercept: -0.196","yintercept: -0.196",null,"yintercept:  0.196","yintercept:  0.196"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(255,0,0,1)","dash":"dash"},"hoveron":"points","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-2.0450000000000008,55.045000000000002,null,-2.0450000000000008,55.045000000000002],"y":[-0.19600000000000001,-0.19600000000000001,null,0.19600000000000001,0.19600000000000001],"text":["yintercept: -0.196","yintercept: -0.196",null,"yintercept:  0.196","yintercept:  0.196"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(255,0,0,1)","dash":"dash"},"hoveron":"points","showlegend":false,"xaxis":"x2","yaxis":"y","hoverinfo":"text","frame":null},{"x":[-2.0450000000000008,55.045000000000002,null,-2.0450000000000008,55.045000000000002],"y":[-0.19600000000000001,-0.19600000000000001,null,0.19600000000000001,0.19600000000000001],"text":["yintercept: -0.196","yintercept: -0.196",null,"yintercept:  0.196","yintercept:  0.196"],"type":"scatter","mode":"lines","line":{"width":1.8897637795275593,"color":"rgba(255,0,0,1)","dash":"dash"},"hoveron":"points","showlegend":false,"xaxis":"x3","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":55.452054794520549,"r":7.3059360730593621,"b":40.182648401826498,"l":48.949771689497723},"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"title":{"text":"PACF for Models A, B and C","font":{"color":"rgba(0,0,0,1)","family":"","size":17.534246575342465},"x":0,"xref":"paper"},"xaxis":{"domain":[0,0.32246140465318546],"automargin":true,"type":"linear","autorange":false,"range":[-2.0450000000000008,55.045000000000002],"tickmode":"array","ticktext":["0","10","20","30","40","50"],"tickvals":[0,10,20,30,40,50],"categoryorder":"array","categoryarray":["0","10","20","30","40","50"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":"","hoverformat":".2f"},"annotations":[{"text":"Lag","x":0.5,"y":0,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"top","annotationType":"axis","yshift":-21.917808219178081},{"text":"ACF","x":0,"y":0.5,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-90,"xanchor":"right","yanchor":"center","annotationType":"axis","xshift":-33.607305936073068},{"text":"Model A","x":0.16123070232659273,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.68949771689498},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"},{"text":"Model B","x":0.5,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.68949771689498},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"},{"text":"Model c","x":0.83876929767340724,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.68949771689498},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"}],"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.31493020452387072,0.22033000973923195],"tickmode":"array","ticktext":["-0.3","-0.2","-0.1","0.0","0.1","0.2"],"tickvals":[-0.30000000000000004,-0.20000000000000004,-0.10000000000000003,0,0.099999999999999978,0.1999999999999999],"categoryorder":"array","categoryarray":["-0.3","-0.2","-0.1","0.0","0.1","0.2"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"x","title":"","hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":0.32246140465318546,"y0":0,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":0.32246140465318546,"y0":0,"y1":23.37899543378996,"yanchor":1,"ysizemode":"pixel"},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0.34420526201348117,"x1":0.65579473798651877,"y0":0,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0.34420526201348117,"x1":0.65579473798651877,"y0":0,"y1":23.37899543378996,"yanchor":1,"ysizemode":"pixel"},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0.67753859534681449,"x1":1,"y0":0,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0.67753859534681449,"x1":1,"y0":0,"y1":23.37899543378996,"yanchor":1,"ysizemode":"pixel"}],"xaxis2":{"type":"linear","autorange":false,"range":[-2.0450000000000008,55.045000000000002],"tickmode":"array","ticktext":["0","10","20","30","40","50"],"tickvals":[0,10,20,30,40,50],"categoryorder":"array","categoryarray":["0","10","20","30","40","50"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"domain":[0.34420526201348117,0.65579473798651877],"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":"","hoverformat":".2f"},"xaxis3":{"type":"linear","autorange":false,"range":[-2.0450000000000008,55.045000000000002],"tickmode":"array","ticktext":["0","10","20","30","40","50"],"tickvals":[0,10,20,30,40,50],"categoryorder":"array","categoryarray":["0","10","20","30","40","50"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"domain":[0.67753859534681449,1],"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176002,"zeroline":false,"anchor":"y","title":"","hoverformat":".2f"},"showlegend":false,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"8001235cfb33":{"x":{},"y":{},"type":"bar"},"80012d6fe368":{"yintercept":{}}},"cur_data":"8001235cfb33","visdat":{"8001235cfb33":["function (y) ","x"],"80012d6fe368":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>It even looks like model.c is worse than model.b in this respect. Really you could go back and forth all day on this!</p>
</section>
</section>
<section id="look-how-maar-corrections-affect-results" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="look-how-maar-corrections-affect-results"><span class="header-section-number">13.4</span> Look how MA/AR corrections affect results</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(model.a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           (Intercept)                   Time           Intervention 
           295.7958393             -2.0147413            -34.3800207 
Post.intervention.time 
            -0.9391869 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(model.b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           (Intercept)                   Time           Intervention 
            293.695634              -2.042827             -21.229331 
Post.intervention.time 
             -1.269343 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(model.c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           (Intercept)                   Time           Intervention 
            293.710803              -2.041917             -21.456791 
Post.intervention.time 
             -1.262984 </code></pre>
</div>
</div>
<p>You can see that there’s some big changes to the values here.</p>
<p>The initial correction we did in model.b had a big effect, changing both the magnitude of the intervention (by ~13 units) and the post.intervention.time (by ~ 0.3 units per week. <strong>Post.intervention.time</strong> describes a weekly trend, so over long time periods, the error would creep up to make a huge difference in your results if you didn’t correct for autocorrelation.</p>
<p>The additional refinement we made by selecting model.c which had a higher value of p and q and which had less variance in the residuals plots, didn’t make as big a difference at all, which I suppose we should expect from looking at the ACF and PACF curves. Higher complexity models would likely overfit the data, make it hard to calculate models on counterfactuals and generally make your life bad, so I suggest just doing something relatively simple and accepting that there’s always some margin of error and a trade-off between predictive capacity and overfitting of the model.</p>
</section>
<section id="ljung-box-test" class="level2" data-number="13.5">
<h2 data-number="13.5" class="anchored" data-anchor-id="ljung-box-test"><span class="header-section-number">13.5</span> Ljung-Box Test</h2>
<p>This simple test will tell you if there’s significant autocorrelation left in the residuals. If p&lt;0.05 there is.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Box.test</span>(<span class="fu">residuals</span>(model.a), <span class="at">type =</span> <span class="st">"Ljung-Box"</span>, <span class="at">lag =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Box-Ljung test

data:  residuals(model.a)
X-squared = 23.272, df = 20, p-value = 0.2756</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Box.test</span>(<span class="fu">residuals</span>(model.b), <span class="at">type =</span> <span class="st">"Ljung-Box"</span>, <span class="at">lag =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Box-Ljung test

data:  residuals(model.b)
X-squared = 23.87, df = 20, p-value = 0.2481</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Box.test</span>(<span class="fu">residuals</span>(model.c), <span class="at">type =</span> <span class="st">"Ljung-Box"</span>, <span class="at">lag =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Box-Ljung test

data:  residuals(model.c)
X-squared = 23.878, df = 20, p-value = 0.2478</code></pre>
</div>
</div>
<p>If we went on this alone, we’d accept the first model.a, but actually I prefer model.b for reasons described above. Obviously, your own data set will have its own set of peculiarities that you’ll need to investigate.</p>
<section id="predicted-values-of-model.b" class="level3" data-number="13.5.1">
<h3 data-number="13.5.1" class="anchored" data-anchor-id="predicted-values-of-model.b"><span class="header-section-number">13.5.1</span> Predicted values of model.b</h3>
<p>OK, so now we’ve dealt with the autocorrelation, let’s assign the predicted values of our preferred model.b on to the df</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>df<span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">model.b.predictions =</span> <span class="fu">predictSE.gls</span> (model.b, df, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">model.b.se =</span> <span class="fu">predictSE.gls</span> (model.b, df, <span class="at">se.fit=</span>T)<span class="sc">$</span>se</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we need to ask what would have happened if there had been no intervention. This is the counterfactual model.</p>
<p>The gls model for the counterfactual looks like this…</p>
<p><strong>gls(quantity.x ~ Time, data = df,method=“ML”)</strong></p>
<p>There’s nothing clever about this, it’s the same model as we had before, only we’ve taken out the intervention and post intervention arguments. Our aim here is to calculate the pre-intervention trend and simply to extrapolate out beyond the intervention time point. This can be done with the <strong>predictSE.gls</strong> function.</p>
<p>To create the counterfactual model, we have to make a new df which truncates the data at the time point immediately before the intervention. Then we run predict on the model, providiing the original df as ‘newdata’.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df2<span class="ot">&lt;-</span><span class="fu">filter</span>(df,Time<span class="sc">&lt;</span><span class="dv">51</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>model.d <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> Time, <span class="at">data =</span> df2, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">2</span>,<span class="at">q=</span><span class="dv">2</span>, <span class="at">form =</span> <span class="sc">~</span> Time),<span class="at">method=</span><span class="st">"ML"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s have a look at how the new counterfactual (model.d, overwriting the old one because I’m lazy) model compares to the factual model (model.a).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(model.a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           (Intercept)                   Time           Intervention 
           295.7958393             -2.0147413            -34.3800207 
Post.intervention.time 
            -0.9391869 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(model.d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)        Time 
 294.392508   -1.998109 </code></pre>
</div>
</div>
<p>As you can see here, the intercept and slope of the factual and counterfactual models are almost identical, which is what we wanted. If you were a purist who cared about those little differences, you could use the actual values from model.a to calculate the counterfactuals manually by doing this</p>
<p>y = 295.7958393 + (Time * -2.0147413)</p>
<p>That’s great in terms of accuracy of your y value estimates, but it is much harder to calculate the standard errors manually so your precision/confidence intervals becomes a real pain. This is especially true when the model gets more complicated (as we’ll see in part two).</p>
<p>So let’s accept a little error in the accuracy and use ‘predict’ because it gives us nice precise confidence estimates, let’s make a new variable with predictions of the counterfactual model, providing the full 100 week data frame as ‘newdata’</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>df<span class="ot">&lt;-</span>df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.d.predictions =</span> <span class="fu">predictSE.gls</span> (model.d, <span class="at">newdata =</span> df, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.d.se =</span> <span class="fu">predictSE.gls</span> (model.d, df, <span class="at">se.fit=</span>T)<span class="sc">$</span>se</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we can plot the chart</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df,<span class="fu">aes</span>(Time,quantity.x))<span class="sc">+</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.d.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.d.se), <span class="at">ymax =</span> model.d.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.d.se)), <span class="at">fill =</span> <span class="st">"pink"</span>)<span class="sc">+</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.d.predictions),<span class="at">color=</span><span class="st">"red"</span>,<span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.b.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.b.se), <span class="at">ymax =</span> model.b.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.b.se)), <span class="at">fill =</span> <span class="st">"lightgreen"</span>)<span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.b.predictions),<span class="at">color=</span><span class="st">"black"</span>,<span class="at">lty=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Interrupted_Time_Series_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The solid line with green ribbon is the factual data, the red dashed line with the pink ribbon is the counterfactual. Using the rule of thumb that if the confidence intervals don’t overlap, there’s something significant happening, we can conclude that the interruption preceded a significant step change in quantity.x. That the lines also diverge suggests that there could be a significant trend change.</p>
<p>The last remaining thing we need to do is to calculate those relative differences. This is easy because we’ve been adding the modelled values to the df as variables. To get a list of the relative differences at different timepoints, we really only have to do subtract the factual from the counterfactual.</p>
<p>Here’ we can ask for the relative differences at weeks 1 (start), 50 (pre-intervention), 51 (immediate post-intervention) and 100 (end of the study)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">format</span>(df<span class="sc">$</span>model.b.predictions<span class="sc">-</span>df<span class="sc">$</span>model.d.predictions,<span class="at">scientific =</span> F)[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">50</span>,<span class="dv">51</span>,<span class="dv">100</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            1            50            51           100 
" -0.7415923" " -2.9327748" "-25.4761670" "-89.8651631" </code></pre>
</div>
</div>
<p>Here we can see that pre-intervention, the difference between factual and counterfactual is essentially zero, which is what we expect. At week 51 we see that the difference is 26 units, almost the same as the step change we saw in the coefficients for model.b above. At week 100 the factual data are 82 units lower than the counterfactual, which is the combined effect of the intervention step change and the intervention trend change.</p>
<hr>
</section>
</section>
<section id="part-two---uncontrolled-its-two-interventions" class="level2" data-number="13.6">
<h2 data-number="13.6" class="anchored" data-anchor-id="part-two---uncontrolled-its-two-interventions"><span class="header-section-number">13.6</span> Part Two - Uncontrolled ITS, two interventions</h2>
<p>Some designs may include multiple interventions and it is fairly simple to extend the model to account for this kind of thing We’ll make a new data set that includes a second intervention and a post-intervention-2 trend.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a dummy dataframe</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Here the interruption takes place at week 51</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>df3<span class="ot">&lt;-</span><span class="fu">tibble</span>(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Time =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">150</span>,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Intervention =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">50</span>),<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">100</span>)),</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Post.intervention.time =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">50</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Intervention.2 =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">100</span>),<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">50</span>)),</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Post.intervention.2.time =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">100</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>),</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">quantity.x =</span> <span class="fu">c</span>(<span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">2000</span><span class="sc">:</span><span class="dv">2500</span>,<span class="at">size =</span> <span class="dv">50</span>,<span class="at">replace =</span> T),<span class="at">decreasing =</span> T)<span class="sc">+</span><span class="fu">sample</span>(<span class="sc">-</span><span class="dv">20</span><span class="sc">:</span><span class="dv">20</span>,<span class="dv">50</span>,<span class="at">replace =</span> T),<span class="fu">c</span>(<span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">200</span><span class="sc">:</span><span class="dv">1700</span>,<span class="at">size =</span> <span class="dv">50</span>,<span class="at">replace =</span> T),<span class="at">decreasing =</span> T)<span class="sc">+</span><span class="fu">sample</span>(<span class="sc">-</span><span class="dv">40</span><span class="sc">:</span><span class="dv">40</span>,<span class="dv">50</span>,<span class="at">replace =</span> T)),<span class="fu">c</span>(<span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">200</span><span class="sc">:</span><span class="dv">450</span>,<span class="at">size =</span> <span class="dv">50</span>,<span class="at">replace =</span> T),<span class="at">decreasing =</span> F)<span class="sc">+</span><span class="fu">sample</span>(<span class="sc">-</span><span class="dv">40</span><span class="sc">:</span><span class="dv">40</span>,<span class="dv">50</span>,<span class="at">replace =</span> T)))</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(df3,<span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">100</span>, <span class="at">scrollY =</span> <span class="st">"200px"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-2514ce28ae593bde0f73" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2514ce28ae593bde0f73">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50],[2484,2495,2487,2479,2447,2453,2433,2409,2411,2410,2406,2407,2404,2379,2376,2375,2354,2341,2351,2334,2337,2300,2307,2247,2242,2254,2244,2246,2220,2192,2207,2161,2144,2126,2140,2137,2121,2119,2094,2092,2103,2099,2086,2033,2041,2034,2036,2006,2021,2017,1589,1598,1596,1540,1488,1529,1456,1412,1317,1316,1307,1315,1244,1242,1180,1190,1209,1218,1135,1106,1077,1024,1004,983,970,898,860,871,864,817,778,819,644,620,591,546,545,475,418,433,408,346,344,346,366,324,295,278,251,274,198,235,176,255,188,209,192,240,232,217,252,246,221,310,309,297,268,304,326,317,318,331,342,304,294,341,295,316,330,359,378,314,354,381,397,336,386,407,420,397,434,450,407,408,442,424,446,419,467,412]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Time<\/th>\n      <th>Intervention<\/th>\n      <th>Post.intervention.time<\/th>\n      <th>Intervention.2<\/th>\n      <th>Post.intervention.2.time<\/th>\n      <th>quantity.x<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":100,"scrollY":"200px","columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"Time","targets":1},{"name":"Intervention","targets":2},{"name":"Post.intervention.time","targets":3},{"name":"Intervention.2","targets":4},{"name":"Post.intervention.2.time","targets":5},{"name":"quantity.x","targets":6}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The new ITS model looks like this</p>
<p><strong>gls(quantity.x ~ Time + Intervention + Post.intervention.time + Intervention.2 + Post.intervention.2.time, data = df,method=“ML”, correlation= corARMA(p=2,q=2, form = ~ Time))</strong></p>
<p>Remember that you should probably deal with autocorrelation at this point. The method is the same as before, so I won’t reproduce it here. I’m just going to make up some values for p and q</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>model.d <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> Time <span class="sc">+</span> Intervention <span class="sc">+</span> Post.intervention.time <span class="sc">+</span> Intervention<span class="fl">.2</span> <span class="sc">+</span> Post.intervention.<span class="fl">2.</span>time, <span class="at">data =</span> df3,<span class="at">method=</span><span class="st">"ML"</span>, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">2</span>,<span class="at">q=</span><span class="dv">2</span>, <span class="at">form =</span> <span class="sc">~</span> Time))</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Show a summary of the model</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model.d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by maximum likelihood
  Model: quantity.x ~ Time + Intervention + Post.intervention.time + Intervention.2 +      Post.intervention.2.time 
  Data: df3 
       AIC      BIC    logLik
  1439.229 1472.346 -708.6146

Correlation Structure: ARMA(2,2)
 Formula: ~Time 
 Parameter estimate(s):
      Phi1       Phi2     Theta1     Theta2 
-0.1786700  0.7084663  0.5430931 -0.3129867 

Coefficients:
                             Value Std.Error   t-value p-value
(Intercept)              2513.1264 18.369456 136.81006   0.000
Time                      -10.1573  0.597890 -16.98864   0.000
Intervention             -361.2113 20.878417 -17.30070   0.000
Post.intervention.time    -18.6064  0.909986 -20.44690   0.000
Intervention.2            -22.0933 20.889070  -1.05765   0.292
Post.intervention.2.time   34.1683  0.909986  37.54819   0.000

 Correlation: 
                         (Intr) Time   Intrvn Pst.n. Intr.2
Time                     -0.851                            
Intervention              0.243 -0.488                     
Post.intervention.time    0.618 -0.779 -0.010              
Intervention.2           -0.025  0.051  0.146 -0.342       
Post.intervention.2.time -0.066  0.135  0.368 -0.577 -0.033

Standardized residuals:
       Min         Q1        Med         Q3        Max 
-3.2828539 -0.6002970  0.1169462  0.6345249  3.0034906 

Residual standard error: 31.75995 
Degrees of freedom: 150 total; 144 residual</code></pre>
</div>
</div>
<p>Referring back to the earlier, more simple example, you can probably see that these coefficients are easy to explain.</p>
<ul>
<li>The <strong>intercept</strong> is still the initial average value of quantity.x</li>
<li><strong>Time</strong> is the pre-intervention slope</li>
<li><strong>Intervention</strong> describes the step change that occurs at the intervention timepoint</li>
<li><strong>Post.intervention.time</strong> describes the additional slope change that occurs at the intervention timepoint</li>
<li><strong>Intervention.2</strong> describes the step change that occurs at the timepoint of the second intervention</li>
<li><strong>Post.intervention.2.time</strong> describes the additional slope change that occurs at the timepoint of the second intervention</li>
</ul>
<p>Let’s grab the estimated modelled values for the new two intervention study</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df3<span class="ot">&lt;-</span>df3 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.d.predictions =</span> <span class="fu">predictSE.gls</span> (model.d, df3, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.d.se =</span> <span class="fu">predictSE.gls</span> (model.d, df3, <span class="at">se.fit=</span>T)<span class="sc">$</span>se</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s draw a picture on which we will show the raw data points, then add the modelled data as a line describing the factual observations and a ribbon showing the 95% confidence interval on the model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df3,<span class="fu">aes</span>(Time,quantity.x))<span class="sc">+</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.d.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.d.se), <span class="at">ymax =</span> model.d.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.d.se)), <span class="at">fill =</span> <span class="st">"lightgreen"</span>)<span class="sc">+</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.d.predictions),<span class="at">color=</span><span class="st">"black"</span>,<span class="at">lty=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Interrupted_Time_Series_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>let’s calculate the first counterfactual, that there were no interventions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>df4<span class="ot">&lt;-</span><span class="fu">filter</span>(df3,Time<span class="sc">&lt;</span><span class="dv">51</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>model.e <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> Time, <span class="at">data =</span> df4, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">1</span>, <span class="at">q=</span><span class="dv">1</span>, <span class="at">form =</span> <span class="sc">~</span> Time),<span class="at">method=</span><span class="st">"ML"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>df3<span class="ot">&lt;-</span>df3 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.e.predictions =</span> <span class="fu">predictSE.gls</span> (model.e, <span class="at">newdata =</span> df3, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.e.se =</span> <span class="fu">predictSE.gls</span> (model.e, df3, <span class="at">se.fit=</span>T)<span class="sc">$</span>se</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and then the second counterfactual, that only the first intervention happened</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df5<span class="ot">&lt;-</span><span class="fu">filter</span>(df3,Time<span class="sc">&lt;</span><span class="dv">101</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>model.f <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> Time <span class="sc">+</span> Intervention <span class="sc">+</span> Post.intervention.time, <span class="at">data =</span> df5, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">1</span>, <span class="at">q=</span><span class="dv">1</span>, <span class="at">form =</span> <span class="sc">~</span> Time),<span class="at">method=</span><span class="st">"ML"</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>df3<span class="ot">&lt;-</span>df3 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.f.predictions =</span> <span class="fu">predictSE.gls</span> (model.f, <span class="at">newdata =</span> df3, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.f.se =</span> <span class="fu">predictSE.gls</span> (model.f, df3, <span class="at">se.fit=</span>T)<span class="sc">$</span>se</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, let’s draw the chart that shows the factual data (black,green), the first (red, pink) and second (navy, turquoise) counterfactuals</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df3,<span class="fu">aes</span>(Time,quantity.x))<span class="sc">+</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.f.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.d.se), <span class="at">ymax =</span> model.f.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.e.se)), <span class="at">fill =</span> <span class="st">"lightblue"</span>)<span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.f.predictions),<span class="at">color=</span><span class="st">"blue"</span>,<span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.e.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.d.se), <span class="at">ymax =</span> model.e.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.e.se)), <span class="at">fill =</span> <span class="st">"pink"</span>)<span class="sc">+</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.e.predictions),<span class="at">color=</span><span class="st">"red"</span>,<span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.d.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.d.se), <span class="at">ymax =</span> model.d.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.d.se)), <span class="at">fill =</span> <span class="st">"lightgreen"</span>)<span class="sc">+</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.d.predictions),<span class="at">color=</span><span class="st">"black"</span>,<span class="at">lty=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Interrupted_Time_Series_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can use the stored modelled values to do any calculations you want with regards to the relative differences. Remember that some things can’t ever go below zero and that your hypothesis probably isn’t that there’s a linear trend that continues forever. Think carefully about your counterfactuals in this context.</p>
<hr>
</section>
<section id="part-three---controlled-its-one-intervention" class="level2" data-number="13.7">
<h2 data-number="13.7" class="anchored" data-anchor-id="part-three---controlled-its-one-intervention"><span class="header-section-number">13.7</span> Part Three - Controlled ITS, one intervention</h2>
<p>Controlled ITS is about as good as it gets when it comes to time series. The control allows you to calibrate the ITS to account for independent secular and periodic changes. Let’s say that quantity.x and quantity.y are related. Both have exhibited some kind of long-range secular change (for instance there’s the pre-intervention trend in the examples above). Let’s say that both quantity.x and quantity.y are experiencing a parallel trend pre-intervention.</p>
<p>The intervention is intented to affect change in quantity.x, but not quantity.y, so post-intervention trends in quantity.y can be taken account for in our model, strenghtening our results.</p>
<p>Let’s make a data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a dummy dataframe</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Here the interruption takes place at week 51</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>df.x<span class="ot">&lt;-</span><span class="fu">tibble</span>(</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="dv">1</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Time =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">x.Time =</span> x<span class="sc">*</span>Time,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Intervention =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">50</span>),<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">50</span>)),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">x.Intervention =</span> x<span class="sc">*</span>Intervention,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Post.intervention.time =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">50</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>),</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">x.Post.intervention.time =</span> x <span class="sc">*</span> Post.intervention.time,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">quantity.x =</span> <span class="fu">c</span>(<span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">200</span><span class="sc">:</span><span class="dv">300</span>,<span class="at">size =</span> <span class="dv">50</span>,<span class="at">replace =</span> T),<span class="at">decreasing =</span> T)<span class="sc">+</span><span class="fu">sample</span>(<span class="sc">-</span><span class="dv">20</span><span class="sc">:</span><span class="dv">20</span>,<span class="dv">50</span>,<span class="at">replace =</span> T),<span class="fu">c</span>(<span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">170</span>,<span class="at">size =</span> <span class="dv">50</span>,<span class="at">replace =</span> T),<span class="at">decreasing =</span> T)<span class="sc">+</span><span class="fu">sample</span>(<span class="sc">-</span><span class="dv">40</span><span class="sc">:</span><span class="dv">40</span>,<span class="dv">50</span>,<span class="at">replace =</span> T)))</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>df.y<span class="ot">&lt;-</span><span class="fu">tibble</span>(</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="dv">0</span>,</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Time =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">x.Time =</span> x<span class="sc">*</span>Time,</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">Intervention =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">50</span>),<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">50</span>)),</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">x.Intervention =</span> x<span class="sc">*</span>Intervention,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">Post.intervention.time =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">50</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>),</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">x.Post.intervention.time =</span> x <span class="sc">*</span> Post.intervention.time,</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">quantity.x =</span> <span class="fu">c</span>(<span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">500</span><span class="sc">:</span><span class="dv">600</span>,<span class="at">size =</span> <span class="dv">50</span>,<span class="at">replace =</span> T),<span class="at">decreasing =</span> T)<span class="sc">+</span><span class="fu">sample</span>(<span class="sc">-</span><span class="dv">20</span><span class="sc">:</span><span class="dv">20</span>,<span class="dv">50</span>,<span class="at">replace =</span> T),<span class="fu">c</span>(<span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">280</span><span class="sc">:</span><span class="dv">500</span>,<span class="at">size =</span> <span class="dv">50</span>,<span class="at">replace =</span> T),<span class="at">decreasing =</span> T)<span class="sc">+</span><span class="fu">sample</span>(<span class="sc">-</span><span class="dv">40</span><span class="sc">:</span><span class="dv">40</span>,<span class="dv">50</span>,<span class="at">replace =</span> T)))</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>df6 <span class="ot">=</span> <span class="fu">bind_rows</span>(df.x,df.y) <span class="sc">%&gt;%</span> </span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Time,x)</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(df6,<span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">200</span>, <span class="at">scrollY =</span> <span class="st">"200px"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-5d05eac75555269eefd0" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-5d05eac75555269eefd0">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200"],[0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],[1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,14,14,15,15,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,30,30,31,31,32,32,33,33,34,34,35,35,36,36,37,37,38,38,39,39,40,40,41,41,42,42,43,43,44,44,45,45,46,46,47,47,48,48,49,49,50,50,51,51,52,52,53,53,54,54,55,55,56,56,57,57,58,58,59,59,60,60,61,61,62,62,63,63,64,64,65,65,66,66,67,67,68,68,69,69,70,70,71,71,72,72,73,73,74,74,75,75,76,76,77,77,78,78,79,79,80,80,81,81,82,82,83,83,84,84,85,85,86,86,87,87,88,88,89,89,90,90,91,91,92,92,93,93,94,94,95,95,96,96,97,97,98,98,99,99,100,100],[0,1,0,2,0,3,0,4,0,5,0,6,0,7,0,8,0,9,0,10,0,11,0,12,0,13,0,14,0,15,0,16,0,17,0,18,0,19,0,20,0,21,0,22,0,23,0,24,0,25,0,26,0,27,0,28,0,29,0,30,0,31,0,32,0,33,0,34,0,35,0,36,0,37,0,38,0,39,0,40,0,41,0,42,0,43,0,44,0,45,0,46,0,47,0,48,0,49,0,50,0,51,0,52,0,53,0,54,0,55,0,56,0,57,0,58,0,59,0,60,0,61,0,62,0,63,0,64,0,65,0,66,0,67,0,68,0,69,0,70,0,71,0,72,0,73,0,74,0,75,0,76,0,77,0,78,0,79,0,80,0,81,0,82,0,83,0,84,0,85,0,86,0,87,0,88,0,89,0,90,0,91,0,92,0,93,0,94,0,95,0,96,0,97,0,98,0,99,0,100],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,14,14,15,15,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,30,30,31,31,32,32,33,33,34,34,35,35,36,36,37,37,38,38,39,39,40,40,41,41,42,42,43,43,44,44,45,45,46,46,47,47,48,48,49,49,50,50],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,2,0,3,0,4,0,5,0,6,0,7,0,8,0,9,0,10,0,11,0,12,0,13,0,14,0,15,0,16,0,17,0,18,0,19,0,20,0,21,0,22,0,23,0,24,0,25,0,26,0,27,0,28,0,29,0,30,0,31,0,32,0,33,0,34,0,35,0,36,0,37,0,38,0,39,0,40,0,41,0,42,0,43,0,44,0,45,0,46,0,47,0,48,0,49,0,50],[587,294,619,316,585,285,583,276,606,291,574,285,608,285,570,303,569,301,577,293,575,300,578,277,593,278,579,266,572,296,574,292,564,275,592,287,562,266,570,280,571,253,555,257,558,247,547,255,565,243,575,244,543,225,539,254,531,253,538,231,540,255,558,229,540,242,551,245,520,256,518,235,515,232,519,234,525,222,514,222,505,217,538,213,515,233,528,206,501,209,499,224,521,207,505,202,523,196,513,218,511,198,479,159,513,198,512,170,452,118,509,150,436,114,461,132,438,133,497,149,497,163,478,167,438,172,473,142,434,113,430,90,393,145,402,144,370,140,422,84,428,131,400,115,391,72,378,123,383,94,351,89,366,73,344,82,358,49,397,95,391,66,316,93,392,108,376,89,377,83,365,76,353,74,311,28,322,58,319,55,302,82,346,79,294,55,305,72,329,23,296,80,305,25,320,70,246,37,311,49]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>x<\/th>\n      <th>Time<\/th>\n      <th>x.Time<\/th>\n      <th>Intervention<\/th>\n      <th>x.Intervention<\/th>\n      <th>Post.intervention.time<\/th>\n      <th>x.Post.intervention.time<\/th>\n      <th>quantity.x<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":200,"scrollY":"200px","columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"x","targets":1},{"name":"Time","targets":2},{"name":"x.Time","targets":3},{"name":"Intervention","targets":4},{"name":"x.Intervention","targets":5},{"name":"Post.intervention.time","targets":6},{"name":"x.Post.intervention.time","targets":7},{"name":"quantity.x","targets":8}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,25,50,100,200]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Look carefully at the dataset. I’ve introduced the variable x (which differentiates between the control (0) and test (1) groups, plus some new <em>Interaction</em> terms including x.Time, x.Intervention and x.Post.intervention.time. Each of these is just the value of the variable, multiplied by x (which indicates control variables [0, i.e.&nbsp;quantity.y] or variables of interest [1, i.e.&nbsp;quantity.x]). This makes those variables null for the controls and meaninful step or trend changes for the lines of the data relating to quantity.x</p>
<p>The ITS model is now a little more complicated. Again, I’ve skipped the step where we test different values of p and q. You should not skip that!</p>
<p>gls(quantity.x ~ Time + x.Time + Intervention + x.Intervention + Post.intervention.time + x.Post.intervention.time, data = df6, correlation= corARMA(p=1, q=1, form = ~ Time|x),method=“ML”)</p>
<p>Note that we’ve had to change the <strong>form = ~ Time|x)</strong> argument in the corARMA to account for the fact that it needs to correct for autocorrelation across time and across the two groups where x == 1 and x == 0</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>model.g <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> x <span class="sc">+</span> Time <span class="sc">+</span> x.Time <span class="sc">+</span> Intervention <span class="sc">+</span> x.Intervention <span class="sc">+</span> Post.intervention.time <span class="sc">+</span> x.Post.intervention.time, <span class="at">data =</span> df6,<span class="at">method=</span><span class="st">"ML"</span>, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">2</span>,<span class="at">q=</span><span class="dv">2</span>, <span class="at">form =</span> <span class="sc">~</span> Time<span class="sc">|</span>x))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Show a summary of the model</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model.g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by maximum likelihood
  Model: quantity.x ~ x + Time + x.Time + Intervention + x.Intervention +      Post.intervention.time + x.Post.intervention.time 
  Data: df6 
     AIC      BIC    logLik
  1758.9 1801.778 -866.4499

Correlation Structure: ARMA(2,2)
 Formula: ~Time | x 
 Parameter estimate(s):
       Phi1        Phi2      Theta1      Theta2 
 0.10771949 -0.45234784 -0.09574448  0.64057848 

Coefficients:
                             Value Std.Error   t-value p-value
(Intercept)               601.6579  6.138936  98.00687  0.0000
x                        -295.7286  8.681766 -34.06318  0.0000
Time                       -1.9366  0.208916  -9.26991  0.0000
x.Time                     -0.0924  0.295452  -0.31265  0.7549
Intervention               -2.5040  8.459708  -0.29599  0.7676
x.Intervention            -32.7129 11.963833  -2.73431  0.0068
Post.intervention.time     -2.4599  0.297490  -8.26891  0.0000
x.Post.intervention.time    1.8554  0.420714   4.41023  0.0000

 Correlation: 
                         (Intr) x      Time   x.Time Intrvn x.Intr Pst.n.
x                        -0.707                                          
Time                     -0.869  0.614                                   
x.Time                    0.614 -0.869 -0.707                            
Intervention              0.340 -0.241 -0.593  0.419                     
x.Intervention           -0.241  0.340  0.419 -0.593 -0.707              
Post.intervention.time    0.616 -0.435 -0.712  0.503 -0.018  0.012       
x.Post.intervention.time -0.435  0.616  0.503 -0.712  0.012 -0.018 -0.707

Standardized residuals:
       Min         Q1        Med         Q3        Max 
-2.5927345 -0.6294354 -0.1224230  0.7533547  2.2872558 

Residual standard error: 18.81718 
Degrees of freedom: 200 total; 192 residual</code></pre>
</div>
</div>
<p>If you were a fancy Dan with these things, you could also use interaction terms in your model to achieve the same result</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>model.h <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> Time<span class="sc">*</span>x <span class="sc">+</span> Intervention<span class="sc">*</span>x <span class="sc">+</span> Post.intervention.time<span class="sc">*</span>x, <span class="at">data =</span> df6,<span class="at">method=</span><span class="st">"ML"</span>, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">2</span>,<span class="at">q=</span><span class="dv">2</span>, <span class="at">form =</span> <span class="sc">~</span> Time<span class="sc">|</span>x))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Show a summary of the model</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model.h)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by maximum likelihood
  Model: quantity.x ~ Time * x + Intervention * x + Post.intervention.time *      x 
  Data: df6 
     AIC      BIC    logLik
  1758.9 1801.778 -866.4499

Correlation Structure: ARMA(2,2)
 Formula: ~Time | x 
 Parameter estimate(s):
       Phi1        Phi2      Theta1      Theta2 
 0.10771949 -0.45234784 -0.09574448  0.64057848 

Coefficients:
                             Value Std.Error   t-value p-value
(Intercept)               601.6579  6.138936  98.00687  0.0000
Time                       -1.9366  0.208916  -9.26991  0.0000
x                        -295.7286  8.681766 -34.06318  0.0000
Intervention               -2.5040  8.459708  -0.29599  0.7676
Post.intervention.time     -2.4599  0.297490  -8.26891  0.0000
Time:x                     -0.0924  0.295452  -0.31265  0.7549
x:Intervention            -32.7129 11.963833  -2.73431  0.0068
x:Post.intervention.time    1.8554  0.420714   4.41023  0.0000

 Correlation: 
                         (Intr) Time   x      Intrvn Pst.n. Time:x x:Intr
Time                     -0.869                                          
x                        -0.707  0.614                                   
Intervention              0.340 -0.593 -0.241                            
Post.intervention.time    0.616 -0.712 -0.435 -0.018                     
Time:x                    0.614 -0.707 -0.869  0.419  0.503              
x:Intervention           -0.241  0.419  0.340 -0.707  0.012 -0.593       
x:Post.intervention.time -0.435  0.503  0.616  0.012 -0.707 -0.712 -0.018

Standardized residuals:
       Min         Q1        Med         Q3        Max 
-2.5927345 -0.6294354 -0.1224230  0.7533547  2.2872558 

Residual standard error: 18.81718 
Degrees of freedom: 200 total; 192 residual</code></pre>
</div>
</div>
<p>See, they’re identical! Personally I prefer to have the variables like x.Intervention written out in my datasets in full. Working with interactions confuses me and I also don’t like the way R presents the coefficients out of order.</p>
<p>So let’s look at the longhand version in detail</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(model.g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             (Intercept)                        x                     Time 
            601.65788853            -295.72858910              -1.93663195 
                  x.Time             Intervention           x.Intervention 
             -0.09237272              -2.50398019             -32.71285979 
  Post.intervention.time x.Post.intervention.time 
             -2.45991389               1.85544370 </code></pre>
</div>
</div>
<p>The interpretation of this is as follows</p>
<ul>
<li><strong>Intercept</strong> is the average value of the control group at the start of the study</li>
<li><strong>x</strong> is the difference between Intercept and the value of quantity.x at the start of the study. To calculate the actual value on the y axis, you’d do 593.4-294.1 = 299.3. When we draw the chart below, you’ll see that the line for quantity.x starts at 299.3 units at week 1.</li>
<li><strong>Time</strong> is the pre-intervention slope for the control group</li>
<li><strong>x.Time</strong> is the difference between Time and the values of quantity.x (see how the control group influences our results!)</li>
<li><strong>Intervention</strong> describes the step change that occurs at the intervention timepoint in the control group</li>
<li><strong>x.Intervention</strong> describes the difference in the step changes that occurs at the intervention timepoint betweent the two groups</li>
<li><strong>Post.intervention.time</strong> describes the slope change that occurs at the intervention timepoint in the control group</li>
<li><strong>x.Post.intervention.time</strong> describes the difference in the slope changes that occurs at the intervention timepoint in the control group</li>
</ul>
<p>Let’s grab the estimated modelled values for the new controlled intervention study</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>df6<span class="ot">&lt;-</span>df6 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.g.predictions =</span> <span class="fu">predictSE.gls</span> (model.g, df6, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.g.se =</span> <span class="fu">predictSE.gls</span> (model.g, df6, <span class="at">se.fit=</span>T)<span class="sc">$</span>se</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then draw a picture on which we will show the raw data points, then add the modelled data as a line describing the factual observations and a ribbon showing the 95% confidence interval on the model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df6,<span class="fu">aes</span>(Time,quantity.x))<span class="sc">+</span><span class="fu">geom_point</span>(<span class="at">color=</span><span class="st">"grey"</span>)<span class="sc">+</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.g.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.g.se), <span class="at">ymax =</span> model.g.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.g.se),<span class="at">fill=</span><span class="fu">factor</span>(x)),<span class="at">alpha=</span><span class="fl">0.4</span>)<span class="sc">+</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.g.predictions,<span class="at">color=</span><span class="fu">factor</span>(x)),<span class="at">lty=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Interrupted_Time_Series_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So let’s calculate the counterfactuals for each of these and add the predictions to the data set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>df7<span class="ot">&lt;-</span><span class="fu">filter</span>(df6,Time<span class="sc">&lt;</span><span class="dv">51</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>model.i <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> x <span class="sc">+</span> Time <span class="sc">+</span> x.Time, <span class="at">data =</span> df7, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">1</span>, <span class="at">q=</span><span class="dv">1</span>, <span class="at">form =</span> <span class="sc">~</span> Time<span class="sc">|</span>x),<span class="at">method=</span><span class="st">"ML"</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>df6<span class="ot">&lt;-</span>df6 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.i.predictions =</span> <span class="fu">predictSE.gls</span> (model.i, <span class="at">newdata =</span> df6, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.i.se =</span> <span class="fu">predictSE.gls</span> (model.i, df6, <span class="at">se.fit=</span>T)<span class="sc">$</span>se</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then plot the results</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df6,<span class="fu">aes</span>(Time,quantity.x))<span class="sc">+</span><span class="fu">geom_point</span>(<span class="at">color=</span><span class="st">"grey"</span>)<span class="sc">+</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.g.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.g.se), <span class="at">ymax =</span> model.g.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.g.se),<span class="at">fill=</span><span class="fu">factor</span>(x)),<span class="at">alpha=</span><span class="fl">0.4</span>)<span class="sc">+</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> model.i.predictions <span class="sc">-</span> (<span class="fl">1.96</span><span class="sc">*</span>model.i.se), <span class="at">ymax =</span> model.i.predictions <span class="sc">+</span> (<span class="fl">1.96</span><span class="sc">*</span>model.i.se),<span class="at">fill=</span><span class="fu">factor</span>(x)),<span class="at">alpha=</span><span class="fl">0.2</span>)<span class="sc">+</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.g.predictions,<span class="at">color=</span><span class="fu">factor</span>(x)),<span class="at">lty=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(Time,model.i.predictions,<span class="at">color=</span><span class="fu">factor</span>(x)),<span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Interrupted_Time_Series_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that in the group of interest, there’s been a big change in the amount of quantity.x since the intervention, but there’s also been a big change in quantity.y the control group. Is the effect we are seeing in the group of interest just happening because of the decline that is happening in both groups, which could indicate that some extrinsic factor influenced change in both groups. If this were the case (assuming that the control group is NOT affected by the intervention) then we’d be incorrectly attributing the result to the intervetion.</p>
<p>Looking closely at the tables of coefficients, we can find some clues. Let’s look back at the fully controlled analysis</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model.g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by maximum likelihood
  Model: quantity.x ~ x + Time + x.Time + Intervention + x.Intervention +      Post.intervention.time + x.Post.intervention.time 
  Data: df6 
     AIC      BIC    logLik
  1758.9 1801.778 -866.4499

Correlation Structure: ARMA(2,2)
 Formula: ~Time | x 
 Parameter estimate(s):
       Phi1        Phi2      Theta1      Theta2 
 0.10771949 -0.45234784 -0.09574448  0.64057848 

Coefficients:
                             Value Std.Error   t-value p-value
(Intercept)               601.6579  6.138936  98.00687  0.0000
x                        -295.7286  8.681766 -34.06318  0.0000
Time                       -1.9366  0.208916  -9.26991  0.0000
x.Time                     -0.0924  0.295452  -0.31265  0.7549
Intervention               -2.5040  8.459708  -0.29599  0.7676
x.Intervention            -32.7129 11.963833  -2.73431  0.0068
Post.intervention.time     -2.4599  0.297490  -8.26891  0.0000
x.Post.intervention.time    1.8554  0.420714   4.41023  0.0000

 Correlation: 
                         (Intr) x      Time   x.Time Intrvn x.Intr Pst.n.
x                        -0.707                                          
Time                     -0.869  0.614                                   
x.Time                    0.614 -0.869 -0.707                            
Intervention              0.340 -0.241 -0.593  0.419                     
x.Intervention           -0.241  0.340  0.419 -0.593 -0.707              
Post.intervention.time    0.616 -0.435 -0.712  0.503 -0.018  0.012       
x.Post.intervention.time -0.435  0.616  0.503 -0.712  0.012 -0.018 -0.707

Standardized residuals:
       Min         Q1        Med         Q3        Max 
-2.5927345 -0.6294354 -0.1224230  0.7533547  2.2872558 

Residual standard error: 18.81718 
Degrees of freedom: 200 total; 192 residual</code></pre>
</div>
</div>
<p>We need to look closely at the numbers here.</p>
<p>In this case, there was a pre-intervention decline in the control group (-1.98 units/week). The quantity.x group was also declining, at a very slightly lower rate (-1.94 units/week)</p>
<p>At the time of the intervention, the control group exhibited a step change of 12.20 units. The quantity.x group meanwhile went down 40.24 units relative to that, so overall it goes down 28.04 units.</p>
<p>Finally, post-intervention, the rate of decline in the control group dipped (-2.94 units/week) whilst the quantity.x group actually went down less steeply (-2.94 + 1.92 = -1.02 units/week).</p>
<p>We might not care too much about these specific rates and numbers. Mostly we care about the big headline number of how much quantity.x has changed compared to the counterfactual, but do take one last look at the table, where the p-values tell you if each coefficient represents an independently significant change.</p>
<p>In this case, Time is significant, indicating that there was a significant change with time prior to the intervention. x.Time is not significant, which means that the pre-intervention trends for quantity.x and the control group are the same. I interpret this to mean that both groups were exhibiting similar trends prior to intervention</p>
<p>Meanwhile, neither Intervention, nor x.Intervention are significant, so maybe we should interpret this to mean that the intervention did not have any immediate effect in the form of a step change.</p>
<p>Finally, both Post.intervention.time and x.Post.intervention.time are significant, which suggests that something influenced the trends in both groups, but that the quantity.x group was affected differently to the control. That much is clear from the pictures, but how we interpret it is something to think about.</p>
<p>It’s possible that the Intervention affected both groups, which would suggest that this is a badly chosen control.</p>
<p>It’s also possible that some extrinsic factor affected both groups around the time that the intervention happened. That’s not good because it leaves us in a position where we can’t determine how much of the effect is due to the intervention and how much is due to the other factors.</p>
<p>In this dummy data, the controls are pretty bad because they change a lot. This is why a lot of the challenge of doing time series</p>
<p>Let’s finally prove what the control is doing (and not doing) by looking at the numbers. At the end of the study, the fully controlled ITS model estimates that there’s a difference between the factual and counterfactual values of quantity.x</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>df6<span class="sc">$</span>model.g.predictions[<span class="dv">200</span>]<span class="sc">-</span>df6<span class="sc">$</span>model.i.predictions[<span class="dv">200</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      200 
-65.23857 </code></pre>
</div>
</div>
<p>Let’s then compare that estimate to an estimate from the same data, but uncontrolled.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>model.j <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> Time <span class="sc">+</span> Intervention  <span class="sc">+</span> Post.intervention.time , <span class="at">data =</span> df.x,<span class="at">method=</span><span class="st">"ML"</span>, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">2</span>,<span class="at">q=</span><span class="dv">2</span>, <span class="at">form =</span> <span class="sc">~</span> Time))</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>df.x <span class="ot">&lt;-</span> df.x <span class="sc">%&gt;%</span> </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.j.predictions =</span> <span class="fu">predictSE.gls</span> (model.j, <span class="at">newdata =</span> df.x, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.j.se =</span> <span class="fu">predictSE.gls</span> (model.j, df.x, <span class="at">se.fit=</span>T)<span class="sc">$</span>se  </span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>df8<span class="ot">&lt;-</span><span class="fu">filter</span>(df.x,Time<span class="sc">&lt;</span><span class="dv">51</span>)</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>model.k <span class="ot">=</span> <span class="fu">gls</span>(quantity.x <span class="sc">~</span> Time, <span class="at">data =</span> df8, <span class="at">correlation=</span> <span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">1</span>, <span class="at">q=</span><span class="dv">1</span>, <span class="at">form =</span> <span class="sc">~</span> Time),<span class="at">method=</span><span class="st">"ML"</span>)</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>df.x<span class="ot">&lt;-</span>df.x <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.k.predictions =</span> <span class="fu">predictSE.gls</span> (model.k, <span class="at">newdata =</span> df.x, <span class="at">se.fit=</span>T)<span class="sc">$</span>fit,</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">model.k.se =</span> <span class="fu">predictSE.gls</span> (model.k, df.x, <span class="at">se.fit=</span>T)<span class="sc">$</span>se</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>df.x<span class="sc">$</span>model.j.predictions[<span class="dv">100</span>]<span class="sc">-</span>df.x<span class="sc">$</span>model.k.predictions[<span class="dv">100</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      100 
-66.60213 </code></pre>
</div>
</div>
<p>There’s not much in it here. In both cases, we estimate a change of around 78 to 79 units in the value of quantity.x Really the controls are there to give you a subjective (eyeballing the charts) and statistical view (looking at the summary tables) of whether you should worry that extrinsic factors might have led you to incorrectly attributing the results to your intervention. In my opinion this is a bit of a silly game because you can’t really ever know whether a control group is being affected by the intervention, the extrinsic factor, or both. If you’ve defined your control group before you start, you might be shooting yourself in the foot by choosing the wrong thing. If you haven’t, you might be cherry-picking a control group simply because it doesn’t change when you, for instance, check it with an uncorrected time series analysis.</p>
<p>In the former case, you don’t know what to do with the data, nor know how to interpret the effects. In the latter case, there’s not really a lot of point, because a control group you’ve specifically cherry-picked for lack of any effect won’t contribute much to the model and so has little value in the statistics or analysis.</p>
<p>Controlled ITS is pretty much the gold standard, though personally I don’t think it often adds much to use the control. Some people like to use synthesised controls, which is probably more robust.</p>
</section>
<section id="final-word" class="level2" data-number="13.8">
<h2 data-number="13.8" class="anchored" data-anchor-id="final-word"><span class="header-section-number">13.8</span> Final word</h2>
<p>You should now be able to do a fairly robust interrupted time series, using controls if you want and calculating counterfactuals for each part of the model. Why not try modifying the controlled ITS to have two interruptions? Or maybe add some periodic covariates, adding effects for seasons, or specific calendar events, or temperature, humidity, region…</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Cumulative_Incidence.html" class="pagination-link" aria-label="Cumulative Incidence">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Cumulative Incidence</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./new_lm_predict_left_predict_right.html" class="pagination-link" aria-label="New lm Predict Left &amp; Predict Right">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">New lm Predict Left &amp; Predict Right</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>